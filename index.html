<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MGV Librería–Regalería</title>
  <meta name="description" content="Artículos de librería y regalería. Comprá por WhatsApp; coordinamos la entrega."/>
  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="styles.css"/>
  <script>
    window.ENV = { GH_OWNER: "ludmilasolutions", GH_REPO: "mgv", GH_BRANCH: "main" };
  </script>
  <script src="assets/js/fetch-raw-patch.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- 🔧 Parche anti-caché para imágenes (afecta sólo al src al vuelo, no al JSON) -->
  <script>
    (function(){
      function getCookie(name){
        try{
          const m=document.cookie.match(new RegExp("(?:^|; )"+name.replace(/([.$?*|{}()\\[\\]\\/+^])/g,"\\$1")+"=([^;]*)"));
          return m ? decodeURIComponent(m[1]) : null;
        }catch(_){ return null; }
      }
      const VERSION = getCookie('mgvsha') || localStorage.getItem('mgv_last_sha') || String(Math.floor(Date.now()/1000));

      function shouldBust(u){
        try{
          if(!u) return false;
          if(/^data:/.test(u)) return false;
          const url = new URL(u, location.href);
          const isImagePath = /\.(png|jpe?g|webp|gif|svg)$/i.test(url.pathname);
          const isRaw = /(^|\.)(githubusercontent\.com)$/.test(url.hostname) || url.hostname === 'raw.githubusercontent.com';
          // Forzamos bust a imágenes crudas (raw GH) y, en general, a rutas de imagen
          return isRaw || isImagePath;
        }catch(_){ return false; }
      }

      function bust(url){
        try{
          const u = new URL(url, location.href);
          if(!u.searchParams.has('v')) u.searchParams.set('v', VERSION);
          return u.toString();
        }catch(_){ return url; }
      }

      // Reescribe atributos existentes al cargar
      function rewriteExisting(){
        document.querySelectorAll('img[src]').forEach(img=>{
          const s = img.getAttribute('src');
          if (shouldBust(s)) {
            const b = bust(s);
            if (b !== s) img.setAttribute('src', b);
          }
        });
      }

      // Parchea setAttribute en <img>
      const origSetAttribute = Element.prototype.setAttribute;
      Element.prototype.setAttribute = function(name, value){
        if (this && this.tagName === 'IMG' && name === 'src' && shouldBust(value)) {
          value = bust(value);
        }
        return origSetAttribute.call(this, name, value);
      };

      // Parchea la propiedad .src directamente
      try{
        const imgProto = HTMLImageElement.prototype;
        const desc = Object.getOwnPropertyDescriptor(imgProto, 'src');
        if (desc && desc.configurable && desc.set && desc.get) {
          Object.defineProperty(imgProto, 'src', {
            set(v){ desc.set.call(this, shouldBust(v) ? bust(v) : v); },
            get(){ return desc.get.call(this); }
          });
        }
      }catch(_){}

      // Fallback: observa mutaciones por si algún navegador ignora lo anterior
      try{
        const mo = new MutationObserver(muts=>{
          for (const m of muts){
            if (m.type === 'attributes' && m.target && m.target.tagName === 'IMG' && m.attributeName === 'src') {
              const el = m.target;
              const s = el.getAttribute('src');
              if (shouldBust(s)) {
                const b = bust(s);
                if (b !== s) el.setAttribute('src', b);
              }
            } else if (m.type === 'childList' && m.addedNodes && m.addedNodes.length){
              m.addedNodes.forEach(n=>{
                if (n.nodeType === 1) {
                  if (n.tagName === 'IMG') {
                    const s = n.getAttribute('src');
                    if (shouldBust(s)) n.setAttribute('src', bust(s));
                  } else {
                    n.querySelectorAll && n.querySelectorAll('img[src]').forEach(img=>{
                      const s = img.getAttribute('src');
                      if (shouldBust(s)) img.setAttribute('src', bust(s));
                    });
                  }
                }
              });
            }
          }
        });
        mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['src']});
      }catch(_){}

      document.addEventListener('DOMContentLoaded', rewriteExisting);
      // Exponemos por si lo querés usar manualmente
      window.__mgvBustSrc = s => shouldBust(s) ? bust(s) : s;
    })();
  </script>
</head>
<body>
  <!-- Topbar fija con búsqueda -->
  <div class="topbar">
    <header class="header container">
      <img src="assets/logo.png" alt="MGV"/>
      <div class="title" id="storeTitle">MGV Librería–Regalería</div>
      <div class="search">
        <input id="q" placeholder="Buscar..." aria-label="Buscar productos"/>
      </div>
    </header>
  </div>

  <!-- Carrusel de banners -->
  <section class="container">
    <div id="bannerCarousel" class="carousel" aria-label="Promociones"></div>
  </section>

  <!-- Píldoras de categorías -->
  <section class="container">
    <div id="categoryPills" class="badges" aria-label="Categorías"></div>
  </section>

  <!-- Catálogo -->
  <main class="container" role="main">
    <div id="productGrid" class="grid"></div>
  </main>

  <!-- FAB y Carrito -->
  <button id="cartFab" class="cart-fab" aria-label="Abrir carrito">🛒 <span id="cartCount">0</span></button>

  <div id="cartPanel" class="cart-panel" style="display:none" aria-modal="true" role="dialog">
    <div class="cart-header">
      <strong>Tu carrito</strong>
      <button id="closeCart" class="close-btn" aria-label="Cerrar">✕</button>
    </div>

    <div id="cartScroll" class="cart-scroll">
      <div class="cart-top">
        <div class="field">
          <label>Método de entrega</label>
          <div id="shipMethod" class="segmented">
            <button class="seg active" data-method="retiro" type="button">🏬 <span>Retiro</span></button>
            <button class="seg" data-method="envio"  type="button">🚚 <span>Envío</span></button>
          </div>
        </div>
        <div class="field">
          <label for="customerName">Tu nombre</label>
          <input id="customerName" type="text" placeholder="Tu nombre"/>
        </div>
      </div>

      <!-- Resumen único -->
      <section id="cartSummary" class="cart-summary">
        <div class="sum-title">Resumen</div>
        <ul id="sumList" class="sum-grid" aria-live="polite"></ul>
        <div id="cartBreakdown" class="cart-breakdown"></div>
      </section>
    </div>

    <div id="cartFooter" class="cart-footer">
      <div class="cart-total">
        <span>Total</span><strong id="cartTotal">$ 0</strong>
      </div>
      <button id="checkoutBtn" class="btn">Finalizar por WhatsApp</button>
    </div>
  </div>

  <!-- Promo inferior -->
  <hr class="soft-divider" />
  <section class="container">
    <div class="promo-card">
      <div class="promo-header">
        <h3>¿Querés una web como esta para tu negocio?</h3>
        <div class="promo-badges">
          <span class="promo-pill">⚡ Entrega rápida</span>
          <span class="promo-pill">📱 100% responsive</span>
          <span class="promo-pill">🧩 Panel para productos</span>
          <span class="promo-pill">🔒 Hosting & dominio opcional</span>
          <span class="promo-pill">✉️ Soporte por email</span>
        </div>
      </div>
      <div class="promo-actions">
        <a class="btn promo-btn" id="promoMail" target="_blank" rel="noopener"
           href="https://wa.me/5493412272899?text=Hola,%20quiero%20presupuesto%20para%20una%20web">Pedí tu presupuesto</a>
        <div class="promo-small">Creado por <strong>Sebastián Mascali</strong></div>
      </div>
    </div>
  </section>

  <footer id="footerInfo" class="container footer"></footer>

  <script src="assets/js/promo.js"></script>
  <script src="app.js"></script>
</body>
</html>
