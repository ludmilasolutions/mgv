<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MGV Librer√≠a‚ÄìRegaler√≠a</title>
  <meta name="description" content="Art√≠culos de librer√≠a y regaler√≠a. Compr√° por WhatsApp; coordinamos la entrega."/>
  <link rel="icon" href="assets/logo.png"/>
  <link id="mainCss" rel="stylesheet" href="styles.css"/>

  <!-- ======== Cache-buster universal (funciona en iOS/Android/Chrome/Safari) ======== -->
  <script>
  (function(){
    const ORG="ludmilasolutions", REPO="mgv";
    function getCookie(n){ const m=document.cookie.match(new RegExp('(?:^|;\\s*)'+n+'=([^;]+)')); return m?m[1]:null; }
    function isSha(x){ return /^[a-f0-9]{40}$/i.test(x||""); }
    const commitSha = getCookie('mgvsha') || localStorage.getItem('mgv_last_sha');
    const TAG = commitSha || String(Date.now());

    function rewriteRawToSha(u){
      if(!u || !isSha(commitSha)) return u;
      try{
        const url=new URL(u, location.href);
        if(url.hostname==='raw.githubusercontent.com'){
          const p=url.pathname.split('/').filter(Boolean);
          if(p.length>=3 && p[0]===ORG && p[1]===REPO && (p[2]==='main'||p[2]==='HEAD')){
            p[2]=commitSha; url.pathname='/'+p.join('/');
          }
        }
        return url.toString();
      }catch(_){ return u; }
    }
    function addTag(u){
      if(!u) return u;
      try{ const url=new URL(u, location.href); if(!url.searchParams.has('v')) url.searchParams.set('v', TAG); return url.toString(); }
      catch(_){ return u + (u.includes('?')?'&':'?') + 'v=' + encodeURIComponent(TAG); }
    }
    function bustURL(u){ return addTag(rewriteRawToSha(u)); }

    // Forzar recarga real del binario en m√≥viles sin SHA (Safari suele ignorar el querystring)
    async function hardReloadIfRaw(imgEl, originalUrl){
      if(isSha(commitSha)) return; // si ya tenemos sha, el path cambi√≥ y no hace falta
      try{
        const u=new URL(originalUrl, location.href);
        if(u.hostname!=='raw.githubusercontent.com') return;
      }catch(_){ return; }
      if(imgEl.dataset.mgvHard==='1') return;
      imgEl.dataset.mgvHard='1';
      try{
        const resp=await fetch(originalUrl, {cache:'reload', mode:'cors'});
        if(!resp.ok) return;
        const blob=await resp.blob();
        const obj=URL.createObjectURL(blob);
        imgEl.src=obj;
      }catch(_){}
    }

    // srcset buster
    function bustSrcset(s){
      if(!s) return s;
      return s.split(',').map(part=>{
        const trimmed=part.trim();
        const sp=trimmed.split(/\s+/);
        const url=sp[0];
        const desc=sp.slice(1).join(' ');
        const busted=bustURL(url);
        return (desc ? (busted+' '+desc) : busted);
      }).join(', ');
    }

    // Parchear setters para atrapar TODAS las asignaciones
    const imgDesc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
    Object.defineProperty(HTMLImageElement.prototype, 'src', {
      set(value){
        const orig = String(value||'');
        const busted = bustURL(orig);
        hardReloadIfRaw(this, orig);
        return imgDesc.set.call(this, busted);
      },
      get(){ return imgDesc.get.call(this); }
    });
    const origImgSetAttr = HTMLImageElement.prototype.setAttribute;
    HTMLImageElement.prototype.setAttribute = function(name, value){
      if(name==='src'){ const orig=String(value||''); const busted=bustURL(orig); hardReloadIfRaw(this, orig); return origImgSetAttr.call(this, name, busted); }
      if(name==='srcset'){ return origImgSetAttr.call(this, name, bustSrcset(String(value||''))); }
      return origImgSetAttr.call(this, name, value);
    };
    // <source> dentro de <picture>
    const origSourceSetAttr = HTMLSourceElement && HTMLSourceElement.prototype.setAttribute;
    if(origSourceSetAttr){
      HTMLSourceElement.prototype.setAttribute=function(name, value){
        if(name==='srcset'){ return origSourceSetAttr.call(this, name, bustSrcset(String(value||''))); }
        if(name==='src'){ return origSourceSetAttr.call(this, name, bustURL(String(value||''))); }
        return origSourceSetAttr.call(this, name, value);
      };
    }

    function applyToElement(el){
      if(!el) return;
      if(el.tagName==='IMG'){
        const raw=el.getAttribute('src') || el.src || '';
        if(raw){ const busted=bustURL(raw); if(raw!==busted) el.src=busted; hardReloadIfRaw(el, raw); }
        const ss=el.getAttribute('srcset'); if(ss){ const bss=bustSrcset(ss); if(bss!==ss) el.setAttribute('srcset', bss); }
      }else if(el.tagName==='SOURCE'){
        const ss=el.getAttribute('srcset'); if(ss){ const bss=bustSrcset(ss); if(bss!==ss) el.setAttribute('srcset', bss); }
        const s2=el.getAttribute('src'); if(s2){ const bs=bustURL(s2); if(bs!==s2) el.setAttribute('src', bs); }
      }else{
        const st = el.style && el.style.backgroundImage;
        if(st && /url\((["']?)(.+?)\1\)/.test(st)){
          const url = st.replace(/^.*url\((["']?)(.+?)\1\).*$/, '$2');
          if(url){ const b=bustURL(url); if(url!==b) el.style.backgroundImage=`url("${b}")`; }
        }
      }
    }
    function applyToTree(root){
      root.querySelectorAll && root.querySelectorAll('img,source,[style*="background-image"]').forEach(applyToElement);
    }

    document.addEventListener('DOMContentLoaded', function(){
      const css=document.getElementById('mainCss'); if(css && css.href) css.href = addTag(css.href);
      applyToTree(document);
      const obs=new MutationObserver(muts=>{
        muts.forEach(m=>{
          if(m.type==='attributes' && (m.attributeName==='src' || m.attributeName==='srcset' || m.attributeName==='style')) applyToElement(m.target);
          if(m.addedNodes && m.addedNodes.length){
            m.addedNodes.forEach(n=>{ if(n.nodeType===1){ applyToElement(n); applyToTree(n); }});
          }
        });
      });
      obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['src','srcset','style']});
    });
    // Exponer por si se necesita en otros scripts
    window.__mgvBustURL = bustURL;
  })();
  </script>
  <!-- ======================================================================== -->

  <script>
    window.ENV = { GH_OWNER: "ludmilasolutions", GH_REPO: "mgv", GH_BRANCH: "main" };
  </script>
  <script src="assets/js/fetch-raw-patch.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Topbar fija con b√∫squeda -->
  <div class="topbar">
    <header class="header container">
      <img src="assets/logo.png" alt="MGV"/>
      <div class="title" id="storeTitle">MGV Librer√≠a‚ÄìRegaler√≠a</div>
      <div class="search">
        <input id="q" placeholder="Buscar..." aria-label="Buscar productos"/>
      </div>
    </header>
  </div>

  <!-- Carrusel de banners -->
  <section class="container">
    <div id="bannerCarousel" class="carousel" aria-label="Promociones"></div>
  </section>

  <!-- P√≠ldoras de categor√≠as -->
  <section class="container">
    <div id="categoryPills" class="badges" aria-label="Categor√≠as"></div>
  </section>

  <!-- Cat√°logo -->
  <main class="container" role="main">
    <div id="productGrid" class="grid"></div>
  </main>

  <!-- FAB y Carrito -->
  <button id="cartFab" class="cart-fab" aria-label="Abrir carrito">üõí <span id="cartCount">0</span></button>

  <div id="cartPanel" class="cart-panel" style="display:none" aria-modal="true" role="dialog">
    <div class="cart-header">
      <strong>Tu carrito</strong>
      <button id="closeCart" class="close-btn" aria-label="Cerrar">‚úï</button>
    </div>

    <div id="cartScroll" class="cart-scroll">
      <div class="cart-top">
        <div class="field">
          <label>M√©todo de entrega</label>
          <div id="shipMethod" class="segmented">
            <button class="seg active" data-method="retiro" type="button">üè¨ <span>Retiro</span></button>
            <button class="seg" data-method="envio"  type="button">üöö <span>Env√≠o</span></button>
          </div>
        </div>
        <div class="field">
          <label for="customerName">Tu nombre</label>
          <input id="customerName" type="text" placeholder="Tu nombre"/>
        </div>
      </div>

      <!-- Resumen √∫nico -->
      <section id="cartSummary" class="cart-summary">
        <div class="sum-title">Resumen</div>
        <ul id="sumList" class="sum-grid" aria-live="polite"></ul>
        <div id="cartBreakdown" class="cart-breakdown"></div>
      </section>
    </div>

    <div id="cartFooter" class="cart-footer">
      <div class="cart-total">
        <span>Total</span><strong id="cartTotal">$ 0</strong>
      </div>
      <button id="checkoutBtn" class="btn">Finalizar por WhatsApp</button>
    </div>
  </div>

  <!-- Promo inferior -->
  <hr class="soft-divider" />
  <section class="container">
    <div class="promo-card">
      <div class="promo-header">
        <h3>¬øQuer√©s una web como esta para tu negocio?</h3>
        <div class="promo-badges">
          <span class="promo-pill">‚ö° Entrega r√°pida</span>
          <span class="promo-pill">üì± 100% responsive</span>
          <span class="promo-pill">üß© Panel para productos</span>
          <span class="promo-pill">üîí Hosting & dominio opcional</span>
          <span class="promo-pill">‚úâÔ∏è Soporte por email</span>
        </div>
      </div>
      <div class="promo-actions">
        <a class="btn promo-btn" id="promoMail" target="_blank" rel="noopener"
           href="https://wa.me/5493412272899?text=Hola,%20quiero%20presupuesto%20para%20una%20web">Ped√≠ tu presupuesto</a>
        <div class="promo-small">Creado por <strong>Sebasti√°n Mascali</strong></div>
      </div>
    </div>
  </section>

  <footer id="footerInfo" class="container footer"></footer>

  <script src="assets/js/promo.js"></script>
  <script src="app.js"></script>
</body>
</html>
