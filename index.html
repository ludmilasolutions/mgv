<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MGV Librería–Regalería</title>
  <meta name="description" content="Artículos de librería y regalería. Comprá por WhatsApp; coordinamos la entrega."/>
  <link rel="icon" href="assets/logo.png"/>
  <link id="mainCss" rel="stylesheet" href="styles.css"/>

  <!-- ================= Cache-buster universal (amigable con iOS) ================= -->
  <script>
  (function(){
    const ORG = "ludmilasolutions";
    const REPO = "mgv";

    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|;\\s*)'+name+'=([^;]+)'));
      return m ? m[1] : null;
    }
    function isSha(x){ return /^[a-f0-9]{40}$/i.test(x||""); }

    // Tag: commit SHA si existe en este dispositivo; si no, timestamp (para cambiar la query)
    const commitSha = (getCookie('mgvsha') || localStorage.getItem('mgv_last_sha'));
    const softTag   = String(Date.now()); // cambia en cada carga (último recurso)
    const TAG       = commitSha || softTag;

    // Reescribe raw.githubusercontent.com ... /main/... -> /<sha>/...
    function rewriteRawToSha(u){
      if(!u) return u;
      if(!isSha(commitSha)) return u; // solo si tenemos SHA real en ESTE equipo
      try{
        const url = new URL(u, location.href);
        if(url.hostname === 'raw.githubusercontent.com'){
          // /owner/repo/(branch|sha)/path...
          const parts = url.pathname.split('/').filter(Boolean);
          // parts: ["owner","repo","main","data","..."]
          if(parts.length >= 3 && parts[0]===ORG && parts[1]===REPO && (parts[2]==='main' || parts[2]==='HEAD')){
            parts[2] = commitSha; // reemplaza main por sha
            url.pathname = '/' + parts.join('/');
          }
        }
        return url.toString();
      }catch(_){ return u; }
    }

    // Agrega ?v=TAG (si no lo tiene ya)
    function addQueryTag(u){
      if(!u) return u;
      try{
        const url = new URL(u, location.href);
        if(!url.searchParams.has('v')) url.searchParams.set('v', TAG);
        return url.toString();
      }catch(_){
        return u + (u.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(TAG);
      }
    }

    // Decide versión final de la URL, aplicando ambas reglas
    function bustURL(u){
      let out = rewriteRawToSha(u);
      out = addQueryTag(out);
      return out;
    }

    // Para iOS (o cuando no hay SHA): fuerza recarga real del binario de raw.githubusercontent.com
    async function hardReloadIfRaw(imgEl, rawUrl){
      try{
        const url = new URL(rawUrl, location.href);
        if(url.hostname !== 'raw.githubusercontent.com') return;
      }catch(_){ return; }

      // Si tenemos SHA real, no hace falta; el path ya cambia.
      if(isSha(commitSha)) return;

      // Evita bucles si ya lo hicimos
      if(imgEl.dataset.mgvHard==='1') return;
      imgEl.dataset.mgvHard = '1';

      try{
        const resp = await fetch(rawUrl, { cache: 'reload', mode: 'cors' });
        if(!resp.ok) return;
        const blob = await resp.blob();
        const objUrl = URL.createObjectURL(blob);
        // guardamos original por si hace falta
        if(!imgEl.dataset.mgvOrig) imgEl.dataset.mgvOrig = rawUrl;
        imgEl.src = objUrl;
      }catch(_){}
    }

    // Aplica buster a un IMG o a un nodo con background-image en style
    function applyToElement(el){
      if(!el) return;
      if(el.tagName === 'IMG'){
        const raw = el.getAttribute('src') || el.src || '';
        if(!raw) return;
        const busted = bustURL(raw);
        if(raw !== busted) el.src = busted;
        hardReloadIfRaw(el, raw); // fuerza reload si es raw GH y no hay SHA
      }else{
        // background-image inline (por si lo usan)
        const st = el.style && el.style.backgroundImage;
        if(st && /url\((["']?)(.+?)\1\)/.test(st)){
          const url = st.replace(/^.*url\((["']?)(.+?)\1\).*$/, '$2');
          if(url){
            const busted = bustURL(url);
            if(url !== busted){
              el.style.backgroundImage = `url("${busted}")`;
              // no hacemos hardReload en bg para no complicar layout
            }
          }
        }
      }
    }

    function applyToTree(root){
      // IMG directos
      root.querySelectorAll && root.querySelectorAll('img').forEach(applyToElement);
      // Algunos layouts usan bg-image en cards
      root.querySelectorAll && root.querySelectorAll('[style*="background-image"]').forEach(applyToElement);
    }

    // Exponer por si lo necesitás en otros scripts
    window.__MGV_CACHE_TAG = TAG;
    window.__mgvBustURL = bustURL;

    // Al cargar el DOM: busteá todo lo que ya está en la página
    document.addEventListener('DOMContentLoaded', function(){
      // CSS con versión (opcional)
      const css = document.getElementById('mainCss');
      if(css && css.href) css.href = addQueryTag(css.href);

      // Header logo + futuras imágenes renderizadas por app.js
      applyToTree(document);

      // Observa elementos nuevos Y cambios de atributos (src / style)
      const obs = new MutationObserver((muts)=>{
        muts.forEach(m=>{
          if(m.type==='attributes'){
            if(m.attributeName==='src' || m.attributeName==='style'){
              applyToElement(m.target);
              return;
            }
          }
          if(m.addedNodes && m.addedNodes.length){
            m.addedNodes.forEach(n=>{
              if(n.nodeType!==1) return;
              applyToElement(n);
              applyToTree(n);
            });
          }
        });
      });
      obs.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['src','style']
      });
    });
  })();
  </script>
  <!-- ======================================================================== -->

  <script>
    window.ENV = { GH_OWNER: "ludmilasolutions", GH_REPO: "mgv", GH_BRANCH: "main" };
  </script>
  <script src="assets/js/fetch-raw-patch.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Topbar fija con búsqueda -->
  <div class="topbar">
    <header class="header container">
      <img src="assets/logo.png" alt="MGV"/>
      <div class="title" id="storeTitle">MGV Librería–Regalería</div>
      <div class="search">
        <input id="q" placeholder="Buscar..." aria-label="Buscar productos"/>
      </div>
    </header>
  </div>

  <!-- Carrusel de banners -->
  <section class="container">
    <div id="bannerCarousel" class="carousel" aria-label="Promociones"></div>
  </section>

  <!-- Píldoras de categorías -->
  <section class="container">
    <div id="categoryPills" class="badges" aria-label="Categorías"></div>
  </section>

  <!-- Catálogo -->
  <main class="container" role="main">
    <div id="productGrid" class="grid"></div>
  </main>

  <!-- FAB y Carrito -->
  <button id="cartFab" class="cart-fab" aria-label="Abrir carrito">🛒 <span id="cartCount">0</span></button>

  <div id="cartPanel" class="cart-panel" style="display:none" aria-modal="true" role="dialog">
    <div class="cart-header">
      <strong>Tu carrito</strong>
      <button id="closeCart" class="close-btn" aria-label="Cerrar">✕</button>
    </div>

    <div id="cartScroll" class="cart-scroll">
      <div class="cart-top">
        <div class="field">
          <label>Método de entrega</label>
          <div id="shipMethod" class="segmented">
            <button class="seg active" data-method="retiro" type="button">🏬 <span>Retiro</span></button>
            <button class="seg" data-method="envio"  type="button">🚚 <span>Envío</span></button>
          </div>
        </div>
        <div class="field">
          <label for="customerName">Tu nombre</label>
          <input id="customerName" type="text" placeholder="Tu nombre"/>
        </div>
      </div>

      <!-- Resumen único -->
      <section id="cartSummary" class="cart-summary">
        <div class="sum-title">Resumen</div>
        <ul id="sumList" class="sum-grid" aria-live="polite"></ul>
        <div id="cartBreakdown" class="cart-breakdown"></div>
      </section>
    </div>

    <div id="cartFooter" class="cart-footer">
      <div class="cart-total">
        <span>Total</span><strong id="cartTotal">$ 0</strong>
      </div>
      <button id="checkoutBtn" class="btn">Finalizar por WhatsApp</button>
    </div>
  </div>

  <!-- Promo inferior -->
  <hr class="soft-divider" />
  <section class="container">
    <div class="promo-card">
      <div class="promo-header">
        <h3>¿Querés una web como esta para tu negocio?</h3>
        <div class="promo-badges">
          <span class="promo-pill">⚡ Entrega rápida</span>
          <span class="promo-pill">📱 100% responsive</span>
          <span class="promo-pill">🧩 Panel para productos</span>
          <span class="promo-pill">🔒 Hosting & dominio opcional</span>
          <span class="promo-pill">✉️ Soporte por email</span>
        </div>
      </div>
      <div class="promo-actions">
        <a class="btn promo-btn" id="promoMail" target="_blank" rel="noopener"
           href="https://wa.me/5493412272899?text=Hola,%20quiero%20presupuesto%20para%20una%20web">Pedí tu presupuesto</a>
        <div class="promo-small">Creado por <strong>Sebastián Mascali</strong></div>
      </div>
    </div>
  </section>

  <footer id="footerInfo" class="container footer"></footer>

  <!-- Mantengo tus scripts tal cual -->
  <script src="assets/js/promo.js"></script>
  <script src="app.js"></script>
</body>
</html>
