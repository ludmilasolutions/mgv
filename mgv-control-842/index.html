<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel MGV</title>
  <link rel="icon" href="../assets/logo.png"/>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .cardx{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#111}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:8px;border-bottom:1px solid var(--border)}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{background:#ffe9e9;border-color:#f3b3b3;color:#a00}
    .success{background:#e9ffed;border-color:#b3f3c5;color:#064}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .btn{background:#111;color:#fff;border:1px solid #111;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    /* Uploader */
    .img-upload{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.75rem;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .img-upload input[type=file]{display:none}
    .preview-thumb{width:64px;height:64px;object-fit:cover;border-radius:.5rem;border:1px solid rgba(0,0,0,.08);background:#fafafa}
    .td-img{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;max-width:360px}
    .td-img .url{min-width:220px;flex:1}
    .td-actions{white-space:nowrap}
    @media (max-width:800px){.row,.row3{grid-template-columns:1fr}.td-img{max-width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="flex">
      <img src="../assets/logo.png" style="height:40px;border-radius:10px" alt="MGV">
      <h2>Panel oculto MGV</h2>
      <div class="right flex muted">
        <span id="apiStatus" class="pill">API: sin configurar</span>
      </div>
    </header>

    <section id="loginSec" class="cardx">
      <h3>Acceso</h3>
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="user" placeholder="admin" value="admin">
        </div>
        <div>
          <label>Contraseña</label>
          <input id="pass" type="password" placeholder="••••••••">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="loginBtn">Ingresar</button>
        <span class="muted">Contraseña temporal: <code>MGV2025!</code> — cambiala en Config.</span>
      </div>
    </section>

    <section id="appSec" class="hidden">
      <div class="flex cardx">
        <button class="btn" id="tabProductos">Productos</button>
        <button class="btn" id="tabBanners">Banners</button>
        <button class="btn" id="tabConfig">Config</button>
        <div class="right flex">
          <button class="btn danger" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>

      <section id="productosSec" class="cardx">
        <div class="flex">
          <h3>Productos</h3>
          <button class="btn right" id="nuevoProd">Nuevo producto</button>
          <button class="btn secondary" id="saveNow">Guardar ahora</button>
        </div>
        <table id="tablaProductos">
          <thead>
            <tr><th>Nombre</th><th>Precio</th><th>Categoría</th><th>Imagen</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="bannersSec" class="cardx hidden">
        <div class="flex">
          <h3>Banners</h3>
          <button class="btn right" id="nuevoBanner">Nuevo banner</button>
          <button class="btn secondary" id="saveNow2">Guardar ahora</button>
        </div>
        <table id="tablaBanners">
          <thead>
            <tr><th>Título</th><th>Texto</th><th>Color</th><th>Activo</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="configSec" class="cardx hidden">
        <h3>Configuración</h3>
        <div class="row">
          <div>
            <label>Nombre de la tienda</label>
            <input id="sName">
          </div>
          <div>
            <label>Número WhatsApp (sin +)</label>
            <input id="waNum" placeholder="549351...">
          </div>
        </div>
        <div class="row3" style="margin-top:8px">
          <div><label>Color texto</label><input id="cText" type="color"></div>
          <div><label>Color tarjeta</label><input id="cCard" type="color"></div>
          <div><label>Color borde</label><input id="cBorder" type="color"></div>
        </div>
        <div class="row3" style="margin-top:8px">
          <div><label>Brand</label><input id="cBrand" type="color"></div>
          <div><label>Accent</label><input id="cAccent" type="color"></div>
          <div><label>BG</label><input id="cBg" type="color"></div>
        </div>
        <h4 style="margin-top:12px">SEO</h4>
        <div class="row">
          <div><label>Título</label><input id="seoTitle"></div>
          <div><label>Descripción</label><input id="seoDesc"></div>
        </div>
        <h4 style="margin-top:12px">Páginas</h4>
        <div class="row">
          <div><label>Quiénes somos</label><textarea id="pgAbout" rows="4"></textarea></div>
          <div><label>Contacto</label><textarea id="pgContact" rows="4"></textarea></div>
        </div>
        <div class="row">
          <div><label>Cambios/Devoluciones</label><textarea id="pgReturns" rows="4"></textarea></div>
          <div><label>Privacidad</label><textarea id="pgPrivacy" rows="4"></textarea></div>
        </div>
        <hr/>
        <h3>Guardar en GitHub</h3>
        <p class="muted">Configurar una vez y queda listo:</p>
        <div class="row3">
          <div><label>API Base (ej: /api)</label><input id="apiBase" placeholder="/api"></div>
          <div><label>Save Token</label><input id="saveToken" placeholder="(no se guarda en repo)"></div>
          <div><label>Probar conexión</label><button class="btn" id="testApi">Test</button></div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn success" id="saveAll">Guardar todo</button>
          <button class="btn secondary" id="dlAll">Descargar JSON</button>
        </div>

        <hr/>
        <h3>Seguridad</h3>
        <div class="row">
          <div>
            <label>Nueva contraseña</label>
            <input id="newPass" type="password" placeholder="Nueva contraseña">
          </div>
          <div>
            <label>Confirmar</label>
            <input id="newPass2" type="password" placeholder="Repetir contraseña">
          </div>
        </div>
        <div class="muted">Al cambiarla, te damos el hash para reemplazá HASHED por el nuevo valor.</div>
      </section>
    </section>
  </div>

  <script>
    // --- Config RAW / helper para base según SHA ---
    const GH_OWNER  = "ludmilasolutions";
    const GH_REPO   = "mgv";
    const GH_BRANCH = "main";
    function rawBase(sha){ return `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${sha||GH_BRANCH}/data`; }

    function setLastSHA(sha){
      try{ if(!sha) return; localStorage.setItem('mgv_last_sha', sha);
        document.cookie='mgvsha='+sha+';path=/;max-age='+(60*60*24*30);
      }catch(_){}
    }
    function getLastSHA(){
      try{ const u=new URL(location.href); const qs=u.searchParams.get('sha'); if(qs){ setLastSHA(qs); return qs; } }catch(_){}
      try{ const ls=localStorage.getItem('mgv_last_sha'); if(ls) return ls; }catch(_){}
      try{ const m=document.cookie.match(/(?:^|;)\s*mgvsha=([^;]+)/); if(m) return m[1]; }catch(_){}
      return null;
    }

    const SALT = "mgv~panel#2025";
    const HASHED = "b950ddfbf98b1a566a9445e569d2e31e894a8026cbf0eb447846b254c820ce23";
    async function sha256(str){const buf=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256',buf); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');}
    function show(id, yes){ document.getElementById(id).classList.toggle('hidden', !yes) }

    const sess = {
      get logged(){ return localStorage.getItem("mgv_logged")==="1" },
      login(){ localStorage.setItem("mgv_logged","1"); },
      logout(){ localStorage.removeItem("mgv_logged"); }
    };

    async function doLogin(){
      const u=document.getElementById("user").value.trim();
      const p=document.getElementById("pass").value;
      if(u!=="admin"){ alert("Usuario inválido"); return; }
      const h=await sha256(SALT+p);
      if(h!==HASHED){ alert("Contraseña incorrecta"); return; }
      sess.login(); boot();
    }

    function boot(){
      if(!localStorage.getItem("mgv_apiBase")) localStorage.setItem("mgv_apiBase","/api");
      show("loginSec", !sess.logged);
      show("appSec",  sess.logged);
      if(sess.logged){
        const _sha=getLastSHA();
        loadTables(_sha);
        hydrateConfigUI();
        updateApiStatus();
      }
    }

    document.getElementById("loginBtn").onclick=doLogin;
    document.getElementById("logoutBtn").onclick=()=>{ sess.logout(); boot(); };

    const tabs={productosSec:"tabProductos",bannersSec:"tabBanners",configSec:"tabConfig"};
    Object.entries(tabs).forEach(([sec,btn])=>{
      document.getElementById(btn).onclick=()=>{ Object.keys(tabs).forEach(id=>show(id,id===sec)); };
    });

    let productos=[], banners=[], config=null;

    async function fetchJsonWithRetry(url, tries=6, wait=700){
      for(let i=0;i<tries;i++){
        try{ const r=await fetch(url,{cache:"no-store"}); if(r.ok){ return await r.json(); } }
        catch(_){}
        await new Promise(res=>setTimeout(res,wait));
      }
      const r=await fetch(url,{cache:"no-store"});
      return r.json();
    }

    async function loadTables(sha){
      const BASE = rawBase(sha || window.__MGV_PENDING_SHA);
      const ts = Date.now();
      productos = await fetchJsonWithRetry(`${BASE}/productos.json?ts=${ts}`);
      banners   = await fetchJsonWithRetry(`${BASE}/banners.json?ts=${ts}`);
      config    = await fetchJsonWithRetry(`${BASE}/config.json?ts=${ts}`);
      window.__MGV_PENDING_SHA = null;
      renderProductos();
      renderBanners();
      hydrateConfigUI();
    }

    // === Enviar Authorization: Bearer <SAVE_TOKEN> a upload-image ===
    async function uploadImageFile(file){
      if(!file) return { ok:false, error:"No file" };
      const fd=new FormData();
      fd.append("file",file,file.name);
      const api=(localStorage.getItem("mgv_apiBase")||"/api")+"/upload-image";
      const tok=(localStorage.getItem("mgv_saveToken")||"").trim();
      const headers = tok ? { "Authorization":"Bearer "+tok } : {};
      const resp=await fetch(api,{ method:"POST", headers, body:fd });
      try{ return await resp.json(); }catch(_){ return {ok:false,error:"Respuesta inválida de la API"}; }
    }

    // Helpers enteros
    const toInt = v => {
      const n = parseInt(String(v||"").replace(/[^\d-]/g,""), 10);
      return isNaN(n) ? 0 : Math.max(0, n);
    };

    function renderProductos(){
      const tbody=document.querySelector("#tablaProductos tbody");
      tbody.innerHTML="";
      productos.forEach(p=>{
        const precioInt = toInt(p.precio);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input value="${p.nombre ?? ''}" data-f="nombre" data-id="${p.id}"/></td>
          <td>
            <input value="${precioInt}" type="number" step="1" min="0" inputmode="numeric" pattern="[0-9]*"
                   data-f="precio" data-id="${p.id}" />
          </td>
          <td><input value="${p.categoria ?? ''}" data-f="categoria" data-id="${p.id}"/></td>
          <td>
            <div class="td-img">
              <input class="url" value="${p.imagen ?? ''}" placeholder="https://…/img.jpg" data-f="imagen" data-id="${p.id}"/>
              <label class="img-upload">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 16v-8m0 0l-3 3m3-3l3 3M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Subir…</span>
                <input type="file" accept="image/*" data-file="${p.id}"/>
              </label>
              <img class="preview-thumb" src="${p.imagen || ''}" alt="Vista previa"/>
              <span class="muted" data-status="${p.id}"></span>
            </div>
          </td>
          <td class="td-actions"><button class="btn secondary" data-ed="${p.id}">Desc</button> <button class="btn danger" data-del="${p.id}">Borrar</button></td>`;
        tbody.appendChild(tr);
      });

      // Evitar que la rueda del mouse cambie el precio
      tbody.querySelectorAll("input[type='number'][data-f='precio']").forEach(n=>{
        n.addEventListener('wheel', e=> e.preventDefault(), {passive:false});
      });

      tbody.querySelectorAll("input.url, td input[type='text'], td input[type='number']").forEach(inp=>{
        const handler=()=>{
          const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
          const p=productos.find(x=>x.id===id); if(!p) return;
          if(f==="precio"){
            p[f] = toInt(inp.value);
            inp.value = p[f]; // normaliza lo que se ve
          }else{
            p[f]=inp.value;
            if(f==="imagen"){
              const row=inp.closest("tr"); const img=row?.querySelector("img.preview-thumb");
              if(img) img.src=inp.value.trim();
            }
          }
        };
        inp.addEventListener("input",handler);
        inp.addEventListener("change",handler);
      });

      tbody.querySelectorAll("[data-ed]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.ed; const p=productos.find(x=>x.id===id); const d=prompt("Descripción",p.descripcion||""); if(d!==null) p.descripcion=d; };
      });
      tbody.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.del; if(confirm("¿Eliminar producto?")){ productos=productos.filter(x=>x.id!==id); renderProductos(); } };
      });
      document.getElementById("nuevoProd").onclick=()=>{
        const id="p"+Math.random().toString(36).slice(2,7);
        productos.unshift({id, nombre:"Nuevo producto", precio:0, categoria:"Librería", imagen:"", descripcion:""});
        renderProductos();
      };

      tbody.querySelectorAll("input[type=file][data-file]").forEach(fi=>{
        fi.addEventListener("change", async ()=>{
          const id=fi.dataset.file;
          const row=fi.closest("tr");
          const urlInp=row.querySelector("input.url[data-id='"+id+"']");
          const prev=row.querySelector("img.preview-thumb");
          const st=row.querySelector("[data-status='"+id+"']");
          const file=fi.files?.[0];
          fi.value="";
          if(!file) return;
          st.textContent="Subiendo imagen…";
          try{
            const res=await uploadImageFile(file);
            if(res.ok){
              urlInp.value=res.url; if(prev) prev.src=res.url;
              const p=productos.find(x=>x.id===id); if(p) p.imagen=res.url;
              st.textContent="Listo ✔";
              if(res.commitSha){ setLastSHA(res.commitSha); window.__MGV_PENDING_SHA=res.commitSha; }
            }else{ st.textContent="Error: "+(res.error||"no se pudo subir"); }
          }catch(e){ st.textContent="Error: "+e.message; }
        });
      });
    }

    function renderBanners(){
      const tbody=document.querySelector("#tablaBanners tbody");
      tbody.innerHTML="";
      banners.forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input value="${b.titulo ?? ''}" data-f="titulo" data-id="${b.id}"/></td>
          <td><input value="${b.texto ?? ''}" data-f="texto" data-id="${b.id}"/></td>
          <td><input value="${b.color ?? '#111111'}" data-f="color" data-id="${b.id}"/></td>
          <td><input type="checkbox" ${b.activo!==false?'checked':''} data-f="activo" data-id="${b.id}"/></td>
          <td class="flex"><button class="btn danger" data-del="${b.id}">Borrar</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("input").forEach(inp=>{
        const handler=()=>{ const id=inp.dataset.id, f=inp.dataset.f; const b=banners.find(x=>x.id===id); if(!b) return; b[f]=(f==="activo")? inp.checked:inp.value; };
        inp.addEventListener("input",handler); inp.addEventListener("change",handler);
      });
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick=()=>{ const id=btn.dataset.del; if(confirm("¿Eliminar banner?")){ banners=banners.filter(x=>x.id!==id); renderBanners(); } };
      });
      document.getElementById("nuevoBanner").onclick=()=>{
        const id="b"+Math.random().toString(36).slice(2,7);
        banners.unshift({id, titulo:"Nuevo banner", texto:"", imagen:"", color:"#111111", activo:true});
        renderBanners();
      };
    }

    function hydrateConfigUI(){
      if(!config) return;
      document.getElementById("sName").value = config.storeName||"";
      document.getElementById("waNum").value = (config.whatsapp&&config.whatsapp.number)||"";
      const t=config.theme||{};
      document.getElementById("cText").value=t.text||"#111111";
      document.getElementById("cCard").value=t.card||"#f7f7f8";
      document.getElementById("cBorder").value=t.border||"#e5e7eb";
      document.getElementById("cBrand").value=t.brand||"#111111";
      document.getElementById("cAccent").value=t.accent||"#d4af37";
      document.getElementById("cBg").value=t.bg||"#ffffff";
      document.getElementById("seoTitle").value=(config.seo&&config.seo.title)||"";
      document.getElementById("seoDesc").value =(config.seo&&config.seo.description)||"";
      document.getElementById("pgAbout").value =(config.pages&&config.pages.about)||"";
      document.getElementById("pgContact").value=(config.pages&&config.pages.contact)||"";
      document.getElementById("pgReturns").value=(config.pages&&config.pages.returns)||"";
      document.getElementById("pgPrivacy").value=(config.pages&&config.pages.privacy)||"";

      document.getElementById("apiBase").value   = localStorage.getItem("mgv_apiBase") || "/api";
      document.getElementById("saveToken").value = localStorage.getItem("mgv_saveToken") || "";
      document.getElementById("testApi").onclick = testApi;
      document.getElementById("saveAll").onclick = saveAll;
      document.getElementById("dlAll").onclick   = dlAll;
      document.getElementById("saveNow").onclick = saveAll;
      document.getElementById("saveNow2").onclick= saveAll;
    }

    function gatherConfigFromUI(){
      const t=(config.theme=config.theme||{});
      config.storeName=document.getElementById("sName").value;
      config.whatsapp=config.whatsapp||{};
      config.whatsapp.number=document.getElementById("waNum").value;
      t.text  =document.getElementById("cText").value;
      t.card  =document.getElementById("cCard").value;
      t.border=document.getElementById("cBorder").value;
      t.brand =document.getElementById("cBrand").value;
      t.accent=document.getElementById("cAccent").value;
      t.bg    =document.getElementById("cBg").value;
      config.seo=config.seo||{};
      config.seo.title=document.getElementById("seoTitle").value;
      config.seo.description=document.getElementById("seoDesc").value;
      config.pages=config.pages||{};
      config.pages.about  =document.getElementById("pgAbout").value;
      config.pages.contact=document.getElementById("pgContact").value;
      config.pages.returns=document.getElementById("pgReturns").value;
      config.pages.privacy=document.getElementById("pgPrivacy").value;
    }

    function updateApiStatus(){
      const base=localStorage.getItem("mgv_apiBase");
      const tok =localStorage.getItem("mgv_saveToken");
      document.getElementById("apiStatus").textContent=`API: ${base||'sin URL'} · Token ${tok?'listo':'falta'}`;
    }

    async function testApi(){
      const base=(document.getElementById("apiBase").value.trim()||"/api");
      const tok =document.getElementById("saveToken").value.trim();
      localStorage.setItem("mgv_apiBase", base);
      localStorage.setItem("mgv_saveToken", tok);
      updateApiStatus();
      try{
        const r=await fetch(base+"/ping");
        alert(r.ok? "Conexión OK" : ("La API respondió con estado "+r.status));
      }catch(e){ alert("No se pudo conectar: "+e.message); }
    }

    function syncTablesBeforeSave(){
      document.querySelectorAll("#tablaProductos tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const p=productos.find(x=>x.id===id); if(!p) return;
        p[f]=(f==="precio")? toInt(inp.value):inp.value;
      });
      document.querySelectorAll("#tablaBanners tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const b=banners.find(x=>x.id===id); if(!b) return;
        b[f]=(f==="activo")? inp.checked:inp.value;
      });
    }

    function dlAll(){
      const a=(name,txt)=>{const blob=new Blob([txt],{type:"application/json"}); const el=document.createElement("a"); el.href=URL.createObjectURL(blob); el.download=name; el.click(); URL.revokeObjectURL(el.href);};
      gatherConfigFromUI();
      a("productos.json", JSON.stringify(productos,null,2));
      a("banners.json",   JSON.stringify(banners,null,2));
      a("config.json",    JSON.stringify(config,null,2));
    }

    async function saveAll(){
      syncTablesBeforeSave(); gatherConfigFromUI();
      const base=localStorage.getItem("mgv_apiBase")||"/api";
      const tok =localStorage.getItem("mgv_saveToken")||"";
      try{
        const r=await fetch(base+"/save_catalog",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+tok},body:JSON.stringify({productos,banners,config})});
        const txt=await r.text(); let j={}; try{ j=JSON.parse(txt);}catch(_){}
        if(r.ok){
          if (j && Array.isArray(j.commits) && j.commits.length) { window.__MGV_PENDING_SHA=j.commits[j.commits.length-1]; setLastSHA(window.__MGV_PENDING_SHA); }
          alert("Guardado en GitHub ✔️"); await loadTables(window.__MGV_PENDING_SHA);
        } else { alert("Error "+r.status+": "+(j.error||txt)); }
      }catch(e){ alert("Error de red: "+e.message); }
    }

    document.getElementById("newPass2").onchange=async ()=>{
      const p1=document.getElementById("newPass").value;
      const p2=document.getElementById("newPass2").value;
      if(!p1 || p1!==p2){ alert("Las contraseñas no coinciden"); return; }
      const h=await sha256(SALT+p1);
      alert("Hash generado. Para cambiarla, abrí este archivo y reemplazá HASHED por:\n\n"+h+"\n\nLuego subilo al repo.");
    };

    boot();
  </script>
</body>
</html>
