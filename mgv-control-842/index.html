<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel MGV</title>
  <link rel="icon" href="../assets/logo.png"/>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .cardx{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#111}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{background:#f9fafb;text-align:left;font-weight:600;color:#111;position:sticky;top:0;z-index:1}
    tbody tr:hover{background:#fbfbfd}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none}
    .btn{background:#111;color:#fff;border:1px solid #111;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.danger{background:#a00;border-color:#a00}
    .img-upload{display:inline-flex;align-items:center;gap:.5rem;font-size:14px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .img-upload input[type=file]{display:none}
    .preview-thumb{width:64px;height:64px;object-fit:cover;border-radius:.5rem;border:1px solid rgba(0,0,0,.08);background:#fafafa}
    .td-img{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;max-width:360px}
    .td-img .url{min-width:220px;flex:1}
    .td-actions{white-space:nowrap}
    @media (max-width:900px){ .row{grid-template-columns:1fr} .row3{grid-template-columns:1fr} th:nth-child(1), td:nth-child(1){position:sticky;left:0;background:#fff}}
  </style>
</head>
<body style="background:#f6f7fb">
  <div class="wrap">
    <header class="flex">
      <img src="../assets/logo.png" style="height:40px;border-radius:10px" alt="MGV">
      <h2>Panel oculto MGV</h2>
      <div class="right flex muted">
        <span id="apiStatus" class="btn secondary" style="pointer-events:none">API: sin configurar</span>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="loginSec" class="cardx">
      <h3>Acceso</h3>
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="user" placeholder="admin" value="admin">
        </div>
        <div>
          <label>Contraseña</label>
          <input id="pass" type="password" placeholder="••••••••">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="loginBtn">Ingresar</button>
        <span class="muted">Contraseña temporal: <code>MGV2025!</code> — cambiala en Config.</span>
      </div>
    </section>

    <!-- APP (TABS) -->
    <section id="appSec" class="hidden">
      <div class="flex cardx">
        <button class="btn" id="tabProductos">Productos</button>
        <button class="btn" id="tabBanners">Banners</button>
        <button class="btn" id="tabConfig">Config</button>
        <div class="right flex">
          <button class="btn danger" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>

      <!-- Productos -->
      <section id="productosSec" class="cardx">
        <div class="flex">
          <h3>Productos</h3>
          <button class="btn right" id="addProd">+ Agregar producto</button>
          <button class="btn secondary" id="reloadProd">Recargar de GitHub</button>
          <button class="btn" id="saveNow">Guardar ahora</button>
        </div>
        <div style="overflow:auto;max-height:420px;border:1px solid var(--border);border-radius:12px;margin-top:8px">
          <table id="tablaProductos">
            <thead>
              <tr>
                <th style="min-width:160px">Producto</th>
                <th style="min-width:120px">Precio</th>
                <th style="min-width:320px">Imagen</th>
                <th>Categoría</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Banners (usa estructura actual: activo/imagen/url) -->
      <section id="bannersSec" class="cardx hidden">
        <div class="flex">
          <h3>Banners</h3>
          <button class="btn right" id="addBan">+ Agregar banner</button>
          <button class="btn secondary" id="reloadBan">Recargar de GitHub</button>
          <button class="btn" id="saveNow2">Guardar ahora</button>
        </div>
        <div style="overflow:auto;max-height:360px;border:1px solid var(--border);border-radius:12px;margin-top:8px">
          <table id="tablaBanners">
            <thead>
              <tr>
                <th>Activo</th>
                <th style="min-width:320px">Imagen</th>
                <th style="min-width:320px">URL</th>
                <th class="td-actions">Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Config -->
      <section id="configSec" class="cardx hidden">
        <h3>Configuración</h3>

        <div class="row">
          <div>
            <label>Nombre de la tienda</label>
            <input id="sName" placeholder="MGV Librería–Regalería">
          </div>
          <div>
            <label>Número WhatsApp (sin +)</label>
            <input id="waNum" placeholder="549341...">
          </div>
        </div>

        <!-- NUEVO: Precio de envío -->
        <div class="row">
          <div>
            <label>Precio de envío (ARS)</label>
            <input id="shipPrice" type="number" min="0" step="1" placeholder="Ej: 2500"/>
            <div class="muted" style="font-size:12px;margin-top:6px">Se aplica al carrito automáticamente. No editable desde el carrito.</div>
          </div>
        </div>

        <div class="row3" style="margin-top:8px">
          <div><label>Color texto</label><input id="cText" type="color" value="#111111"></div>
          <div><label>Color tarjeta</label><input id="cCard" type="color" value="#f7f7f8"></div>
          <div><label>Color borde</label><input id="cBorder" type="color" value="#e5e7eb"></div>
        </div>
        <div class="row3" style="margin-top:8px">
          <div><label>Brand</label><input id="cBrand" type="color" value="#111111"></div>
          <div><label>Accent</label><input id="cAccent" type="color" value="#d4af37"></div>
          <div><label>BG</label><input id="cBg" type="color" value="#ffffff"></div>
        </div>

        <h4 style="margin-top:12px">SEO</h4>
        <div class="row">
          <div><label>Título</label><input id="seoTitle"></div>
          <div><label>Descripción</label><input id="seoDesc"></div>
        </div>

        <h4 style="margin-top:12px">Páginas</h4>
        <div class="row">
          <div><label>Quiénes somos</label><textarea id="pgAbout" rows="4"></textarea></div>
          <div><label>Contacto</label><textarea id="pgContact" rows="4"></textarea></div>
        </div>
        <div class="row">
          <div><label>Cambios/Devoluciones</label><textarea id="pgReturns" rows="4"></textarea></div>
          <div><label>Privacidad</label><textarea id="pgPrivacy" rows="4"></textarea></div>
        </div>

        <h3 style="margin-top:12px">Guardar en GitHub</h3>
        <div class="muted">Configurar una vez y queda listo:</div>
        <div class="row">
          <div>
            <label>API Base (ej: /api)</label>
            <input id="apiBase" placeholder="/api">
          </div>
          <div>
            <label>Save Token</label>
            <input id="saveToken" placeholder="Bearer token">
          </div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn" id="testApiBtn">Probar conexión</button>
          <span id="apiStatus2" class="muted">Test</span>
          <div class="right"></div>
          <button class="btn secondary" id="dlAllBtn">Descargar JSON</button>
          <button class="btn" id="saveAllBtn">Guardar todo</button>
        </div>

        <h3 style="margin-top:12px">Seguridad</h3>
        <div class="row">
          <div>
            <label>Nueva contraseña</label>
            <input id="newPass" type="password" placeholder="••••••••">
          </div>
          <div>
            <label>Confirmar</label>
            <input id="newPass2" type="password" placeholder="••••••••">
          </div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn" id="setPassBtn">Actualizar contraseña</button>
          <span class="muted">Al cambiarla, te damos el hash para reemplazá <code>HASHED</code> por el nuevo valor.</span>
        </div>
      </section>
    </section>
  </div>

  <script>
    // --- Config RAW / helper para base según SHA ---
    const GH_OWNER  = "ludmilasolutions";
    const GH_REPO   = "mgv";
    const GH_BRANCH = "main";
    function rawBase(sha){ return `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${sha||GH_BRANCH}/data`; }

    function setLastSHA(sha){
      try{ if(!sha) return; localStorage.setItem('mgv_last_sha', sha);
        document.cookie='mgvsha='+sha+';path=/;max-age='+(60*60*24*30);
      }catch(_){}
    }
    function getLastSHA(){
      try{ const u=new URL(location.href); const qs=u.searchParams.get('sha'); if(qs){ setLastSHA(qs); return qs; } }catch(_){}
      try{ const ls=localStorage.getItem('mgv_last_sha'); if(ls) return ls; }catch(_){}
      try{ const c = (document.cookie||'').split(';').map(s=>s.trim()).find(s=>s.startsWith('mgvsha=')); if(c) return c.split('=')[1]; }catch(_){}
      return GH_BRANCH;
    }

    // Login simple (hash local, con SALT)
    const SALT = "mgv~panel#2025";
    const PASS_HASH = "HASHED"; // reemplazar cuando actualices
    async function sha(s){ return crypto.subtle.digest("SHA-256", new TextEncoder().encode(s)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("")); }
    function show(id, yes){ document.getElementById(id).classList.toggle('hidden', !yes); }

    const sess = {
      get logged(){ return localStorage.getItem("mgv_logged")==="1"; },
      login(){ localStorage.setItem("mgv_logged","1"); },
      logout(){ localStorage.removeItem("mgv_logged"); }
    };

    async function doLogin(){
      const u = (document.getElementById("user").value||"").trim();
      const p = (document.getElementById("pass").value||"").trim();
      if(u!=="admin") return alert("Usuario inválido (usa admin).");
      const h = await sha(SALT+p);
      if(PASS_HASH!=="HASHED" && h!==PASS_HASH) return alert("Contraseña incorrecta.");
      sess.login();
      boot(); // oculta login y muestra tabs
    }

    function boot(){
      // estado inicial
      show("loginSec", !sess.logged);
      show("appSec",  sess.logged);
      if(!sess.logged) return;

      // cargar data
      loadTables(getLastSHA()).then(()=>{
        hydrateConfigUI();
        updateApiStatus();
      });
    }

    // Tabs
    const tabs={productosSec:"tabProductos",bannersSec:"tabBanners",configSec:"tabConfig"};
    Object.entries(tabs).forEach(([sec,btn])=>{
      document.getElementById(btn).onclick=()=>{
        Object.keys(tabs).forEach(id=>show(id,id===sec));
      };
    });

    // Logout
    document.getElementById("loginBtn").onclick=doLogin;
    document.getElementById("logoutBtn").onclick=()=>{ sess.logout(); boot(); };

    // Data
    let productos=[], banners=[], config=null;

    async function fetchJsonWithRetry(url, tries=6, wait=700){
      for(let i=0;i<tries;i++){
        try{ const r=await fetch(url,{cache:"no-store"}); if(r.ok){ return await r.json(); } }
        catch(_){}
        await new Promise(res=>setTimeout(res,wait));
      }
      const r=await fetch(url,{cache:"no-store"});
      return r.json();
    }

    async function loadTables(sha){
      const BASE = rawBase(sha || window.__MGV_PENDING_SHA);
      const ts = Date.now();
      productos = await fetchJsonWithRetry(`${BASE}/productos.json?ts=${ts}`);
      banners   = await fetchJsonWithRetry(`${BASE}/banners.json?ts=${ts}`);
      config    = await fetchJsonWithRetry(`${BASE}/config.json?ts=${ts}`);
      window.__MGV_PENDING_SHA = null;
      renderProductos();
      renderBanners();
    }

    // === Enviar Authorization: Bearer <SAVE_TOKEN> a upload-image ===
    async function uploadImageFile(file){
      if(!file) return { ok:false, error:"No file" };
      const fd=new FormData();
      fd.append("file",file,file.name);
      const api=(localStorage.getItem("mgv_apiBase")||"/api")+"/upload-image";
      const tok=(localStorage.getItem("mgv_saveToken")||"").trim();
      const headers = tok ? { "Authorization":"Bearer "+tok } : {};
      const resp=await fetch(api,{ method:"POST", headers, body:fd });
      try{ return await resp.json(); }catch(_){ return {ok:false,error:"Respuesta inválida de la API"}; }
    }

    // Helpers
    const toInt = v => { const n = parseInt(String(v||"").replace(/[^\d-]/g,""), 10); return isNaN(n) ? 0 : Math.max(0, n); };

    function renderProductos(){
      const tbody=document.querySelector("#tablaProductos tbody");
      tbody.innerHTML="";
      (productos||[]).forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input data-id="${p.id}" data-f="nombre" value="${p.nombre||''}" placeholder="Nombre"></td>
          <td><input data-id="${p.id}" data-f="precio" value="${toInt(p.precio)||0}" type="number" step="1" min="0"></td>
          <td class="td-img">
            <img alt="prev" class="preview-thumb" src="${p.imagen||''}"/>
            <input class="url" data-id="${p.id}" data-f="imagen" value="${p.imagen||''}" placeholder="https://...">
            <label class="img-upload">Subir<input type="file" accept="image/*" data-up="${p.id}"></label>
          </td>
          <td><input data-id="${p.id}" data-f="categoria" value="${p.categoria||''}" placeholder="Categoría"></td>
          <td class="td-actions">
            <button class="btn secondary" data-ed="${p.id}">Editar descripción</button>
            <button class="btn danger" data-del="${p.id}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // listeners
      document.querySelectorAll("#tablaProductos tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const p=productos.find(x=>x.id===id); if(!p) return;
        const handler = ()=>{
          if(f==="precio"){
            p.precio = toInt(inp.value);
            inp.value = p.precio;
          }else{
            p[f]=inp.value;
            if(f==="imagen"){
              const row=inp.closest("tr"); const img=row?.querySelector("img.preview-thumb");
              if(img) img.src=inp.value.trim();
            }
          }
        };
        inp.addEventListener("input",handler);
        inp.addEventListener("change",handler);
      });

      tbody.querySelectorAll("[data-ed]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.ed; const p=productos.find(x=>x.id===id); const d=prompt("Descripción", p.descripcion||""); if(p){ p.descripcion=d||""; } };
      });
      tbody.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.del; if(confirm("¿Borrar producto?")){ productos = productos.filter(x=>x.id!==id); renderProductos(); } };
      });
      document.getElementById("addProd").onclick=()=>{
        const id = "p"+(Date.now());
        productos.unshift({id, nombre:"Nuevo producto", precio:0, categoria:"", imagen:"", descripcion:""});
        renderProductos();
      };
      document.getElementById("reloadProd").onclick=()=> loadTables(getLastSHA());

      // guardar rápido
      document.getElementById("saveNow").onclick=saveAll;
    }

    function renderBanners(){
      const tbody=document.querySelector("#tablaBanners tbody");
      tbody.innerHTML="";
      (banners||[]).forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input type="checkbox" data-id="${b.id}" data-f="activo" ${b.activo?'checked':''}></td>
          <td class="td-img">
            <img alt="prev" class="preview-thumb" src="${b.imagen||''}"/>
            <input class="url" data-id="${b.id}" data-f="imagen" value="${b.imagen||''}" placeholder="https://...">
            <label class="img-upload">Subir<input type="file" accept="image/*" data-upb="${b.id}"></label>
          </td>
          <td><input data-id="${b.id}" data-f="url" value="${b.url||''}" placeholder="https://..."></td>
          <td class="td-actions"><button class="btn danger" data-delb="${b.id}">Borrar</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll("#tablaBanners tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const b=banners.find(x=>x.id===id); if(!b) return;
        const handler=()=>{
          if(f==="activo"){ b.activo = inp.checked; }
          else { b[f]=inp.value; if(f==="imagen"){ const row=inp.closest("tr"); const img=row?.querySelector("img.preview-thumb"); if(img) img.src=inp.value.trim(); } }
        };
        inp.addEventListener("input",handler);
        inp.addEventListener("change",handler);
      });

      tbody.querySelectorAll("[data-delb]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.delb; if(confirm("¿Borrar banner?")){ banners = banners.filter(x=>x.id!==id); renderBanners(); } };
      });

      document.querySelectorAll('input[type="file"][data-upb]').forEach(file=>{
        file.onchange=async ()=>{
          const id=file.dataset.upb; const f=file.files?.[0]; if(!f) return;
          const res=await uploadImageFile(f);
          if(res?.ok && res.url){
            const b=banners.find(x=>x.id===id); if(b){ b.imagen=res.url; renderBanners(); }
          }else{
            alert(res?.error||"Error subiendo imagen");
          }
        };
      });

      document.getElementById("addBan").onclick=()=>{
        const id="b"+Date.now();
        banners.unshift({id, activo:true, imagen:"", url:""});
        renderBanners();
      };
      document.getElementById("reloadBan").onclick=()=> loadTables(getLastSHA());
      document.getElementById("saveNow2").onclick=saveAll;
    }

    function hydrateConfigUI(){
      if(!config) return;
      document.getElementById("sName").value = config.storeName||"";
      document.getElementById("waNum").value = (config.whatsapp&&config.whatsapp.number)||"";
      document.getElementById("shipPrice").value = (config.shipping && (config.shipping.price ?? config.shipping.default)) || 0;

      const t=config.theme||{};
      document.getElementById("cText").value=t.text||"#111111";
      document.getElementById("cCard").value=t.card||"#f7f7f8";
      document.getElementById("cBorder").value=t.border||"#e5e7eb";
      document.getElementById("cBrand").value=t.brand||"#111111";
      document.getElementById("cAccent").value=t.accent||"#d4af37";
      document.getElementById("cBg").value=t.bg||"#ffffff";
      document.getElementById("seoTitle").value=(config.seo&&config.seo.title)||"";
      document.getElementById("seoDesc").value =(config.seo&&config.seo.description)||"";
      document.getElementById("pgAbout").value =(config.pages&&config.pages.about)||"";
      document.getElementById("pgContact").value=(config.pages&&config.pages.contact)||"";
      document.getElementById("pgReturns").value=(config.pages&&config.pages.returns)||"";
      document.getElementById("pgPrivacy").value=(config.pages&&config.pages.privacy)||"";

      document.getElementById("apiBase").value   = localStorage.getItem("mgv_apiBase") || "/api";
      document.getElementById("saveToken").value = localStorage.getItem("mgv_saveToken") || "";

      // Override local para previsualización inmediata en la tienda
      const shipInp = document.getElementById("shipPrice");
      const pushOverride = ()=>{
        const v = toInt(shipInp.value);
        try { localStorage.setItem('mgv_config_override', JSON.stringify({ shipping: { price: v } })); } catch(_){}
      };
      shipInp.addEventListener('input', pushOverride);
      shipInp.addEventListener('change', pushOverride);
      pushOverride();
    }

    function gatherConfigFromUI(){
      const t=(config.theme=config.theme||{});
      config.storeName=document.getElementById("sName").value;
      config.whatsapp=config.whatsapp||{};
      config.whatsapp.number=document.getElementById("waNum").value;
      config.shipping = config.shipping || {};
      config.shipping.price = toInt(document.getElementById("shipPrice").value);
      t.text  =document.getElementById("cText").value;
      t.card  =document.getElementById("cCard").value;
      t.border=document.getElementById("cBorder").value;
      t.brand =document.getElementById("cBrand").value;
      t.accent=document.getElementById("cAccent").value;
      t.bg    =document.getElementById("cBg").value;
      config.seo=config.seo||{};
      config.seo.title=document.getElementById("seoTitle").value;
      config.seo.description=document.getElementById("seoDesc").value;
      config.pages=config.pages||{};
      config.pages.about  =document.getElementById("pgAbout").value;
      config.pages.contact=document.getElementById("pgContact").value;
      config.pages.returns=document.getElementById("pgReturns").value;
      config.pages.privacy=document.getElementById("pgPrivacy").value;
    }

    function updateApiStatus(){
      const base=localStorage.getItem("mgv_apiBase");
      const tok =localStorage.getItem("mgv_saveToken");
      document.getElementById("apiStatus").textContent=`API: ${base||'sin URL'} · Token ${tok?'listo':'falta'}`;
      document.getElementById("apiStatus2").textContent = document.getElementById("apiStatus").textContent;
    }

    async function testApi(){
      const base=(document.getElementById("apiBase").value.trim()||"/api");
      const tok =document.getElementById("saveToken").value.trim();
      localStorage.setItem("mgv_apiBase", base);
      localStorage.setItem("mgv_saveToken", tok);
      updateApiStatus();
      try{
        const r=await fetch(base+"/ping",{headers: tok?{"Authorization":"Bearer "+tok}:{}, cache:"no-store"});
        alert(r.ok? "Conexión OK" : ("La API respondió con estado "+r.status));
      }catch(_){
        alert("No se pudo conectar");
      }
    }

    function syncTablesBeforeSave(){
      document.querySelectorAll("#tablaProductos tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const p=productos.find(x=>x.id===id); if(!p) return;
        p[f]=(f==="precio")? toInt(inp.value):inp.value;
      });
      document.querySelectorAll("#tablaBanners tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const b=banners.find(x=>x.id===id); if(!b) return;
        b[f]=(f==="activo")? inp.checked:inp.value;
      });
    }

    function dlAll(){
      const a=(name,txt)=>{const blob=new Blob([txt],{type:"application/json"}); const url=URL.createObjectURL(blob); const an=document.createElement("a"); an.href=url; an.download=name; an.click(); setTimeout(()=>URL.revokeObjectURL(url),250);};
      syncTablesBeforeSave(); gatherConfigFromUI();
      a("productos.json", JSON.stringify(productos,null,2));
      a("banners.json",   JSON.stringify(banners,null,2));
      a("config.json",    JSON.stringify(config,null,2));
    }

    async function saveAll(){
      syncTablesBeforeSave(); gatherConfigFromUI();
      const base=localStorage.getItem("mgv_apiBase")||"/api";
      const tok =localStorage.getItem("mgv_saveToken")||"";
      try{
        const r=await fetch(base+"/save_catalog",{method:"POST",headers:{"Content-Type":"application/json", ...(tok?{"Authorization":"Bearer "+tok}:{})},body:JSON.stringify({productos,banners,config})});
        const txt=await r.text(); let j={}; try{ j=JSON.parse(txt);}catch(_){}
        if(r.ok){
          if (j && Array.isArray(j.commits) && j.commits.length) { window.__MGV_PENDING_SHA=j.commits[j.commits.length-1]; setLastSHA(window.__MGV_PENDING_SHA); }
          alert("Guardado OK");
        }else{
          alert("Error guardando: " + (j.error||txt||r.status));
        }
      }catch(err){
        alert("Error de red: "+err.message);
      }
    }

    async function setNewPass(){
      const a=document.getElementById("newPass").value;
      const b=document.getElementById("newPass2").value;
      if(!a||!b||a!==b) return alert("Las contraseñas no coinciden.");
      const h = await sha(SALT+a);
      prompt("Reemplazá el valor de PASS_HASH por este:", h);
    }

    // Eventos UI
    document.getElementById("testApiBtn").onclick=testApi;
    document.getElementById("dlAllBtn").onclick=dlAll;
    document.getElementById("saveAllBtn").onclick=saveAll;
    document.getElementById("setPassBtn").onclick=setNewPass;

    // Autologin para pruebas si PASS_HASH está sin configurar
    (async()=>{ try{
      const u=new URL(location.href); if(u.searchParams.get("autologin")==="1"){ document.getElementById("pass").value="MGV2025!"; await doLogin(); }
    }catch(_){}})();

    // Arranque
    boot();
  </script>
</body>
</html>
