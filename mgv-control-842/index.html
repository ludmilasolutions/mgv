<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel MGV</title>
  <link rel="icon" href="../assets/logo.png"/>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .cardx{background:#131722;border:1px solid #23283b;border-radius:16px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #2b3347;background:#0f1115;color:#e9eef7}
    label{font-size:12px;color:#9aa3b2}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:8px;border-bottom:1px solid #222}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{background:#421f24;border-color:#5b2731}
    .success{background:#244225;border-color:#2f5b31}
    .muted{color:#9aa3b2;font-size:12px}
    .hidden{display:none}
    .pill{border:1px solid #2b3347;border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="flex">
      <img src="../assets/logo.png" style="height:40px;border-radius:10px">
      <h2>Panel oculto MGV</h2>
      <div class="right flex muted">
        <span id="ghStatus" class="pill">GitHub: sin token</span>
      </div>
    </header>

    <section id="loginSec" class="cardx">
      <h3>Acceso</h3>
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="user" placeholder="admin" value="admin">
        </div>
        <div>
          <label>Contraseña</label>
          <input id="pass" type="password" placeholder="••••••••">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="loginBtn">Ingresar</button>
        <span class="muted">Tip: cambiá la contraseña después de entrar.</span>
      </div>
    </section>

    <section id="appSec" class="hidden">
      <div class="flex cardx">
        <button class="btn" id="tabProductos">Productos</button>
        <button class="btn" id="tabBanners">Banners</button>
        <button class="btn" id="tabConfig">Config</button>
        <div class="right flex">
          <button class="btn danger" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>

      <section id="productosSec" class="cardx">
        <div class="flex">
          <h3>Productos</h3>
          <button class="btn right" id="nuevoProd">Nuevo producto</button>
        </div>
        <table id="tablaProductos">
          <thead>
            <tr><th>Nombre</th><th>Precio</th><th>Categoría</th><th>Imagen</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="bannersSec" class="cardx hidden">
        <div class="flex">
          <h3>Banners</h3>
          <button class="btn right" id="nuevoBanner">Nuevo banner</button>
        </div>
        <table id="tablaBanners">
          <thead>
            <tr><th>Título</th><th>Texto</th><th>Color</th><th>Activo</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="configSec" class="cardx hidden">
        <h3>Configuración</h3>
        <div class="row">
          <div>
            <label>Nueva contraseña (opcional)</label>
            <input id="newPass" type="password" placeholder="Nueva contraseña">
          </div>
          <div>
            <label>Confirmar</label>
            <input id="newPass2" type="password" placeholder="Repetir contraseña">
          </div>
        </div>
        <hr/>
        <h4>Guardar cambios</h4>
        <p class="muted">Elegí cómo guardar los cambios en <code>data/*.json</code>.</p>
        <div class="row">
          <div class="cardx">
            <h4>1) Descargar archivos</h4>
            <p>Descargá los JSON y subilos al repo por GitHub (Add file → Upload files).</p>
            <button class="btn" id="dlProductos">Descargar productos.json</button>
            <button class="btn" id="dlBanners">Descargar banners.json</button>
          </div>
          <div class="cardx">
            <h4>2) Guardar directo en GitHub (opcional)</h4>
            <p>Pegá un GitHub Token (repo scope) – se guarda sólo en tu navegador (localStorage).</p>
            <label>Token</label>
            <input id="ghToken" placeholder="ghp_...">
            <label>Owner</label>
            <input id="ghOwner" placeholder="usuario-o-org">
            <label>Repo</label>
            <input id="ghRepo" placeholder="mgv-tienda">
            <label>Branch</label>
            <input id="ghBranch" placeholder="main" value="main">
            <div class="flex" style="margin-top:8px">
              <button class="btn success" id="saveGitHub">Guardar en GitHub</button>
              <span class="muted">⚠️ Sólo usar en privado y con cuidado.</span>
            </div>
          </div>
        </div>

        <hr/>
        <h4>Mercado Pago (opcional)</h4>
        <p>Endpoint backend para crear preferencias (Netlify/Cloudflare). Editá <code>APP_CONFIG.MP_BACKEND_URL</code> en <code>/app.js</code>.</p>
      </section>
    </section>
  </div>

  <script>
    const SALT = "mgv~panel#2025";
    const HASHED = "e13fcbd099220d799d26f927451b0c530ccd466011e5dafaddc8136ca5a0bb89";
    async function sha256(str){const buf = new TextEncoder().encode(str); const hash = await crypto.subtle.digest('SHA-256', buf); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');}
    function show(id, yes){ document.getElementById(id).classList.toggle('hidden', !yes) }

    const sess = {
      get logged(){ return localStorage.getItem("mgv_logged")==="1" },
      login(){ localStorage.setItem("mgv_logged","1"); },
      logout(){ localStorage.removeItem("mgv_logged"); }
    };

    async function doLogin(){
      const u = document.getElementById("user").value.trim();
      const p = document.getElementById("pass").value;
      if(u!=="admin"){ alert("Usuario inválido"); return; }
      const h = await sha256(SALT + p);
      if(h!==HASHED){ alert("Contraseña incorrecta"); return; }
      sess.login(); boot();
    }

    function boot(){
      show("loginSec", !sess.logged);
      show("appSec", sess.logged);
      if(sess.logged){
        loadTables();
        updateGhStatus();
      }
    }

    document.getElementById("loginBtn").onclick = doLogin;
    document.getElementById("logoutBtn").onclick = ()=>{ sess.logout(); boot(); }

    const tabs = { productosSec: "tabProductos", bannersSec: "tabBanners", configSec: "tabConfig" };
    Object.entries(tabs).forEach(([sec, btn])=>{
      document.getElementById(btn).onclick = ()=>{
        Object.keys(tabs).forEach(id=> show(id, id===sec));
      };
    });

    let productos = [];
    let banners = [];
    async function loadTables(){
      productos = await (await fetch("../data/productos.json?ts="+Date.now())).json();
      banners = await (await fetch("../data/banners.json?ts="+Date.now())).json();
      renderProductos();
      renderBanners();
    }

    function renderProductos(){
      const tbody = document.querySelector("#tablaProductos tbody");
      tbody.innerHTML = "";
      productos.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${p.nombre}" data-f="nombre" data-id="${p.id}"/></td>
          <td><input value="${p.precio}" type="number" data-f="precio" data-id="${p.id}"/></td>
          <td><input value="${p.categoria}" data-f="categoria" data-id="${p.id}"/></td>
          <td><input value="${p.imagen}" data-f="imagen" data-id="${p.id}"/></td>
          <td class="flex"><button class="btn" data-ed="${p.id}">Editar</button> <button class="btn danger" data-del="${p.id}">Borrar</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("input").forEach(inp=>{
        inp.onchange = ()=>{
          const id = inp.dataset.id, f = inp.dataset.f;
          const p = productos.find(x=>x.id===id);
          if(!p) return;
          p[f] = (f==="precio")? Number(inp.value) : inp.value;
        };
      });
      tbody.querySelectorAll("[data-ed]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.dataset.ed;
          const p = productos.find(x=>x.id===id);
          const desc = prompt("Descripción", p.descripcion||"");
          if(desc!==null){ p.descripcion = desc; renderProductos(); }
        };
      });
      tbody.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.dataset.del;
          if(confirm("¿Eliminar producto?")){
            productos = productos.filter(x=>x.id!==id);
            renderProductos();
          }
        };
      });
      document.getElementById("nuevoProd").onclick = ()=>{
        const id = "p"+Math.random().toString(36).slice(2,7);
        productos.unshift({id, nombre:"Nuevo producto", precio:0, categoria:"Librería", imagen:"", descripcion:""});
        renderProductos();
      };
    }

    function renderBanners(){
      const tbody = document.querySelector("#tablaBanners tbody");
      tbody.innerHTML = "";
      banners.forEach(b=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input value="${b.titulo}" data-f="titulo" data-id="${b.id}"/></td>
          <td><input value="${b.texto||''}" data-f="texto" data-id="${b.id}"/></td>
          <td><input value="${b.color||'#ffd700'}" data-f="color" data-id="${b.id}"/></td>
          <td><input type="checkbox" ${b.activo!==false?'checked':''} data-f="activo" data-id="${b.id}"/></td>
          <td class="flex"><button class="btn danger" data-del="${b.id}">Borrar</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll("input").forEach(inp=>{
        inp.onchange = ()=>{
          const id = inp.dataset.id, f = inp.dataset.f;
          const b = banners.find(x=>x.id===id);
          if(!b) return;
          b[f] = (f==="activo")? inp.checked : inp.value;
        };
      });
      document.getElementById("nuevoBanner").onclick = ()=>{
        const id = "b"+Math.random().toString(36).slice(2,7);
        banners.unshift({id, titulo:"Nuevo banner", texto:"", imagen:"", color:"#ffd700", activo:true});
        renderBanners();
      };
    }

    function download(filename, text){
      const blob = new Blob([text], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    document.getElementById("dlProductos").onclick = ()=> download("productos.json", JSON.stringify(productos, null, 2));
    document.getElementById("dlBanners").onclick = ()=> download("banners.json", JSON.stringify(banners, null, 2));

    const $ghToken = document.getElementById("ghToken");
    const $ghOwner = document.getElementById("ghOwner");
    const $ghRepo = document.getElementById("ghRepo");
    const $ghBranch = document.getElementById("ghBranch");
    const $ghStatus = document.getElementById("ghStatus");
    [$ghToken,$ghOwner,$ghRepo,$ghBranch].forEach(inp=>{
      inp.value = localStorage.getItem("mgv_"+inp.id) || inp.value;
      inp.oninput = ()=> localStorage.setItem("mgv_"+inp.id, inp.value);
    });

    function updateGhStatus(){
      const t = localStorage.getItem("mgv_ghToken");
      $ghStatus.textContent = "GitHub: " + (t? "token listo" : "sin token");
    }

    async function saveGithubFile(path, content, message){
      const token = localStorage.getItem("mgv_ghToken");
      const owner = localStorage.getItem("mgv_ghOwner");
      const repo = localStorage.getItem("mgv_ghRepo");
      const branch = localStorage.getItem("mgv_ghBranch") || "main";
      if(!token || !owner || !repo) throw new Error("Faltan credenciales de GitHub");
      let sha = null;
      const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`,{
        headers:{Authorization:"Bearer "+token,"Accept":"application/vnd.github+json"}
      });
      if(getRes.status===200){
        const j = await getRes.json();
        sha = j.sha;
      }
      const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
        method:"PUT",
        headers:{Authorization:"Bearer "+token,"Accept":"application/vnd.github+json"},
        body: JSON.stringify({
          message,
          content: btoa(unescape(encodeURIComponent(content))),
          branch,
          sha
        })
      });
      if(!putRes.ok){
        const txt = await putRes.text();
        throw new Error("GitHub error: "+txt);
      }
    }

    document.getElementById("saveGitHub").onclick = async ()=>{
      try{
        await saveGithubFile("data/productos.json", JSON.stringify(productos, null, 2), "chore: update productos.json");
        await saveGithubFile("data/banners.json", JSON.stringify(banners, null, 2), "chore: update banners.json");
        alert("Archivos guardados en GitHub ✔️");
      }catch(e){
        alert(e.message);
      }
    };

    document.getElementById("newPass2").onchange = async ()=>{
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;
      if(!p1 || p1!==p2){ alert("Las contraseñas no coinciden"); return; }
      const h = await sha256(SALT + p1);
      alert("Hash generado. Para cambiarlo permanentemente, reemplazá HASHED en este archivo por:\n\n"+h+"\n\n(sugerencia: descargá este HTML, reemplazá y subí al repo).");
    };

    boot();
  </script>
</body>
</html>
