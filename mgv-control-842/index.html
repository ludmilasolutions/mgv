<!-- mgv-control-842/index.html (fragment to insert) -->
<!-- Add in <head> -->
<link rel="stylesheet" href="../assets/css/uploader.css">
<script type="module">
  import { uploadImage } from "../assets/js/uploader.js";
  window.__mgvUploadHook = async (inputEl, urlInputEl, previewEl, statusEl) => {
    const file = inputEl.files?.[0];
    if (!file) return;
    statusEl.textContent = "Subiendo imagen…";
    try {
      const res = await uploadImage(file);
      if (res.ok) {
        urlInputEl.value = res.url;        // set product image URL
        previewEl.src = res.url;           // show preview
        statusEl.textContent = "Listo ✔";
        // optional: guarda el último SHA para impedir caché
        localStorage.mgv_last_sha = res.commitSha;
        document.cookie = `mgvsha=${res.commitSha}; path=/; max-age=2592000; samesite=Lax`;
      } else {
        statusEl.textContent = "Error: " + (res.error || "no se pudo subir");
      }
    } catch(e) {
      statusEl.textContent = "Error: " + e.message;
    } finally {
      inputEl.value = "";
    }
  };
</script>

<!-- Add in the product editor form near the Image URL field -->
<div class="field">
  <label>Imagen del producto</label>
  <div style="display:flex; align-items:center; gap:1rem; flex-wrap: wrap;">
    <input id="productImageUrl" type="url" placeholder="https://…/mi-imagen.jpg" style="min-width:260px; flex:1"/>
    <label class="img-upload">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 16v-8m0 0l-3 3m3-3l3 3M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Subir…</span>
      <input id="productImageFile" type="file" accept="image/*"/>
    </label>
    <img id="productImagePreview" class="preview-thumb" src="" alt="Vista previa"/>
    <span id="uploadStatus" style="font-size:.9rem;opacity:.8"></span>
  </div>
</div>

<script>
  // Wire up after DOM is ready
  window.addEventListener('DOMContentLoaded', () => {
    const f = document.getElementById('productImageFile');
    const url = document.getElementById('productImageUrl');
    const prev = document.getElementById('productImagePreview');
    const st = document.getElementById('uploadStatus');
    // If url already filled, preview
    if (url && url.value) prev.src = url.value;
    f?.addEventListener('change', () => window.__mgvUploadHook(f, url, prev, st));
  });
</script>
