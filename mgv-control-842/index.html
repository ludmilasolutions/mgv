<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Panel MGV</title>
  <link rel="icon" href="../assets/logo.png"/>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --brand:#0ea5e9; --accent:#f59e0b;
      --card-bg:#ffffff; --page-bg:#f8fafc;
    }
    /* Base */
    html,body{height:100%}
    body{background:var(--page-bg);color:#0b1220;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.35}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 12px;margin:-16px -16px 12px;z-index:5}
    .cardx{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#111;font-size:16px}
    label{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:8px;border-bottom:1px solid var(--border);vertical-align:middle}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{background:#ffe9e9;border-color:#f3b3b3;color:#a00}
    .success{background:#e9ffed;border-color:#b3f3c5;color:#064}
    .muted{color:var(--muted);font-size:12px}
    .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .btn{background:#111;color:#fff;border:1px solid #111;border-radius:12px;padding:10px 14px;cursor:pointer;touch-action:manipulation}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:#111}
    .btn.small{padding:8px 12px;font-size:14px;border-radius:10px}
    .btn.warn{background:#f59e0b;border-color:#f59e0b;color:#111}
    .btn.brand{background:#0ea5e9;border-color:#0ea5e9}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .toolbar .grow{flex:1}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .hidden{display:none}
    .td-img{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;max-width:420px}
    .preview-thumb{width:56px;height:56px;object-fit:cover;border-radius:.5rem;border:1px solid rgba(0,0,0,.08);background:#fafafa}
    .td-actions{white-space:nowrap;display:flex;gap:6px;flex-wrap:wrap}
    .drag-handle{cursor:grab;color:#475569}
    .dragging{opacity:.6}
    .sticky-head{position:sticky;top:0;background:#fff}
    .table-wrap{max-width:100%;overflow:auto;border:1px solid var(--border);border-radius:12px}
    .table-foot{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 0}
    .pagination{display:flex;gap:8px;align-items:center}
    .select-all{margin-left:6px}
    .searchbar input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
    .kpi{display:flex;gap:8px;align-items:center}
    .kpi .dot{width:8px;height:8px;border-radius:50%;background:#10b981}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:99}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    dialog{border:1px solid var(--border);border-radius:12px;padding:0;max-width:780px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(2,6,23,.35)}
    .dlg-head{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .dlg-body{padding:12px 14px;max-height:60vh;overflow:auto}
    .dlg-foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .diff-add{color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:8px;padding:6px 8px}
    .diff-del{color:#991b1b;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:6px 8px}
    .diff-chg{color:#1f2937;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px}
    .img-upload{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.75rem;border:1px solid var(--border);cursor:pointer;font-weight:600}
    .img-upload input[type=file]{display:none}
    .status-ok{color:#16a34a}.status-err{color:#b91c1c}

    /* Botón flotante de guardado solo en móvil */
    .fab-save{position:fixed;right:16px;bottom:16px;z-index:60;border-radius:999px;padding:12px 16px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none}
    .fab-save .dot{margin-left:8px;width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block}

    /* ===== Responsive móvil ===== */
    @media (max-width:900px){
      .row,.row3{grid-template-columns:1fr}
      .table-wrap{overflow:auto}
      header{border-radius:0}
      .toolbar{gap:10px}
      .btn.small{font-size:15px}
      .cardx{padding:14px}
    }
    /* Tabla como tarjetas en pantallas pequeñas */
    @media (max-width:720px){
      table, thead, tbody, th, tr{display:block}
      thead{display:none}
      tbody{display:grid;gap:12px;padding:8px}
      tr{border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px}
      td{display:flex;align-items:center;justify-content:space-between;border:none;padding:8px 6px}
      td[data-label]::before{
        content:attr(data-label);
        font-size:12px;color:var(--muted);margin-right:8px;flex:0 0 auto;
      }
      td.col-aux{order:-10;display:flex;gap:8px}
      .drag-handle{font-size:18px}
      .td-actions{gap:8px}
      .mv-btn{display:inline-flex}
      .preview-thumb{width:64px;height:64px}
      .img-upload{padding:.6rem .8rem}
      .fab-save{display:inline-flex;align-items:center}
    }
    .mv-btn{display:none}
  </style>

  <!-- ======== Cache-buster igual que en la web pública ======== -->
  <script>
  (function(){
    const ORG="ludmilasolutions", REPO="mgv";
    function getCookie(n){ const m=document.cookie.match(new RegExp('(?:^|;\\s*)'+n+'=([^;]+)')); return m?m[1]:null; }
    function isSha(x){ return /^[a-f0-9]{40}$/i.test(x||""); }
    const commitSha = getCookie('mgvsha') || localStorage.getItem('mgv_last_sha');
    const TAG = commitSha || String(Date.now());

    function rewriteRawToSha(u){
      if(!u || !isSha(commitSha)) return u;
      try{
        const url=new URL(u, location.href);
        if(url.hostname==='raw.githubusercontent.com'){
          const p=url.pathname.split('/').filter(Boolean);
          if(p.length>=3 && p[0]===ORG && p[1]===REPO && (p[2]==='main'||p[2]==='HEAD')){
            p[2]=commitSha; url.pathname='/'+p.join('/');
          }
        }
        return url.toString();
      }catch(_){ return u; }
    }
    function addTag(u){
      if(!u) return u;
      try{ const url=new URL(u, location.href); if(!url.searchParams.has('v')) url.searchParams.set('v', TAG); return url.toString(); }
      catch(_){ return u + (u.includes('?')?'&':'?') + 'v=' + encodeURIComponent(TAG); }
    }
    function bustURL(u){ return addTag(rewriteRawToSha(u)); }

    async function hardReloadIfRaw(imgEl, originalUrl){
      if(isSha(commitSha)) return;
      try{
        const u=new URL(originalUrl, location.href);
        if(u.hostname!=='raw.githubusercontent.com') return;
      }catch(_){ return; }
      if(imgEl.dataset.mgvHard==='1') return;
      imgEl.dataset.mgvHard='1';
      try{
        const resp=await fetch(originalUrl, {cache:'reload', mode:'cors'});
        if(!resp.ok) return;
        const blob=await resp.blob();
        const obj=URL.createObjectURL(blob);
        imgEl.src=obj;
      }catch(_){}
    }

    function bustSrcset(s){
      if(!s) return s;
      return s.split(',').map(part=>{
        const trimmed=part.trim();
        const sp=trimmed.split(/\s+/);
        const url=sp[0];
        const desc=sp.slice(1).join(' ');
        const busted=bustURL(url);
        return (desc ? (busted+' '+desc) : busted);
      }).join(', ');
    }

    const imgDesc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
    Object.defineProperty(HTMLImageElement.prototype, 'src', {
      set(value){
        const orig=String(value||'');
        const busted=bustURL(orig);
        hardReloadIfRaw(this, orig);
        return imgDesc.set.call(this, busted);
      },
      get(){ return imgDesc.get.call(this); }
    });
    const origImgSetAttr = HTMLImageElement.prototype.setAttribute;
    HTMLImageElement.prototype.setAttribute=function(name, value){
      if(name==='src'){ const orig=String(value||''); const busted=bustURL(orig); hardReloadIfRaw(this, orig); return origImgSetAttr.call(this,name,busted); }
      if(name==='srcset'){ return origImgSetAttr.call(this, name, bustSrcset(String(value||''))); }
      return origImgSetAttr.call(this, name, value);
    };
    const origSourceSetAttr = HTMLSourceElement && HTMLSourceElement.prototype.setAttribute;
    if(origSourceSetAttr){
      HTMLSourceElement.prototype.setAttribute=function(name, value){
        if(name==='srcset'){ return origSourceSetAttr.call(this, name, bustSrcset(String(value||''))); }
        if(name==='src'){ return origSourceSetAttr.call(this, name, bustURL(String(value||''))); }
        return origSourceSetAttr.call(this, name, value);
      };
    }

    function applyToElement(el){
      if(!el) return;
      if(el.tagName==='IMG'){
        const raw=el.getAttribute('src') || el.src || '';
        if(raw){ const b=bustURL(raw); if(raw!==b) el.src=b; hardReloadIfRaw(el, raw); }
        const ss=el.getAttribute('srcset'); if(ss){ const bss=bustSrcset(ss); if(bss!==ss) el.setAttribute('srcset', bss); }
      }else if(el.tagName==='SOURCE'){
        const ss=el.getAttribute('srcset'); if(ss){ const bss=bustSrcset(ss); if(bss!==ss) el.setAttribute('srcset', bss); }
        const s2=el.getAttribute('src'); if(s2){ const bs=bustURL(s2); if(bs!==s2) el.setAttribute('src', bs); }
      }else{
        const st=el.style && el.style.backgroundImage;
        if(st && /url\((["']?)(.+?)\1\)/.test(st)){
          const url = st.replace(/^.*url\((["']?)(.+?)\1\).*$/, '$2');
          if(url){ const b=bustURL(url); if(url!==b) el.style.backgroundImage=`url("${b}")`; }
        }
      }
    }
    function applyToTree(root){
      root.querySelectorAll && root.querySelectorAll('img,source,[style*="background-image"]').forEach(applyToElement);
    }

    document.addEventListener('DOMContentLoaded', function(){
      applyToTree(document);
      const obs=new MutationObserver(muts=>{
        muts.forEach(m=>{
          if(m.type==='attributes' && (m.attributeName==='src'||m.attributeName==='srcset'||m.attributeName==='style')) applyToElement(m.target);
          if(m.addedNodes && m.addedNodes.length){
            m.addedNodes.forEach(n=>{ if(n.nodeType===1){ applyToElement(n); applyToTree(n); }});
          }
        });
      });
      obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['src','srcset','style']});
      window.bustURL = bustURL;
    });
  })();
  </script>
  <!-- ===================================================================== -->
</head>
<body>
  <div class="wrap">
    <header class="flex">
      <img src="../assets/logo.png" style="height:44px;border-radius:10px" alt="MGV">
      <h2>Panel oculto MGV <span id="dirtyDot" class="muted" style="display:none">● Cambios sin guardar</span></h2>
      <div class="right flex muted">
        <span id="apiStatus" class="pill">API: sin configurar</span>
      </div>
    </header>

    <!-- Login -->
    <section id="loginSec" class="cardx">
      <h3>Acceso</h3>
      <div class="row">
        <div>
          <label>Usuario</label>
          <input id="user" placeholder="admin" value="admin">
        </div>
        <div>
          <label>Contraseña</label>
          <input id="pass" type="password" placeholder="••••••••">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button class="btn" id="loginBtn">Ingresar</button>
        <span class="muted">Contraseña temporal: <code>MGV2025!</code> — cambiala en Config.</span>
      </div>
    </section>

    <!-- App -->
    <section id="appSec" class="hidden">
      <div class="flex cardx">
        <button class="btn" id="tabProductos">Productos</button>
        <button class="btn" id="tabBanners">Banners</button>
        <button class="btn" id="tabConfig">Config</button>
        <div class="right flex">
          <button class="btn danger" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>

      <!-- Productos -->
      <section id="productosSec" class="cardx">
        <div class="toolbar">
          <div class="searchbar grow">
            <input id="prodSearch" placeholder="Buscar por nombre o descripción…">
          </div>
          <select id="prodCatFilter">
            <option value="">Categoría: todas</option>
          </select>
          <label class="badge"><input type="checkbox" id="fNoImg"> sin imagen</label>
          <label class="badge"><input type="checkbox" id="fNoDesc"> sin descripción</label>
          <label class="badge"><input type="checkbox" id="fNoPrice"> sin precio</label>
          <button class="btn secondary" id="clearFilters">Limpiar</button>
          <div class="right kpi"><span class="dot"></span><span class="muted">Listo para editar</span></div>
        </div>

        <div class="toolbar">
          <div class="flex">
            <label class="badge"><input type="checkbox" id="selectAll" class="select-all"> Seleccionar todo (página)</label>
            <button class="btn small danger" id="bulkDelete" disabled>🗑 Borrar seleccionados</button>
            <button class="btn small warn" id="bulkUp10" disabled>+10% precio</button>
            <button class="btn small secondary" id="bulkRound" disabled>Redondear a 100</button>
          </div>
          <div class="right flex">
            <input type="file" id="importFile" accept="application/json" class="hidden">
            <button class="btn secondary small" id="importBtn">Importar JSON</button>
            <button class="btn secondary small" id="exportBtn">Exportar JSON</button>
            <button class="btn brand small" id="saveNow">Guardar ahora</button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="tablaProductos">
            <thead class="sticky-head">
              <tr>
                <th style="width:28px"></th>
                <th style="width:28px"><input type="checkbox" id="hdrChk"></th>
                <th>Nombre</th>
                <th style="width:120px">Precio</th>
                <th style="width:180px">Categoría</th>
                <th>Imagen</th>
                <th style="width:160px"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-foot">
          <div class="muted" id="rowsInfo">0 items</div>
          <div class="pagination">
            <label class="muted">Por página</label>
            <select id="pageSize">
              <option>25</option><option selected>50</option><option>100</option><option>200</option>
            </select>
            <button class="btn secondary small" id="pagePrev">‹</button>
            <span class="muted" id="pageLabel">1 / 1</span>
            <button class="btn secondary small" id="pageNext">›</button>
          </div>
          <div class="right">
            <button class="btn secondary small" id="nuevoProd">Nuevo producto</button>
          </div>
        </div>
      </section>

      <!-- Banners -->
      <section id="bannersSec" class="cardx hidden">
        <div class="flex">
          <h3>Banners</h3>
          <button class="btn right" id="nuevoBanner">Nuevo banner</button>
          <button class="btn secondary" id="saveNow2">Guardar ahora</button>
        </div>
        <div class="table-wrap">
          <table id="tablaBanners">
            <thead class="sticky-head">
              <tr>
                <th>Título</th><th>Texto</th><th>Color</th><th>Imagen</th><th>Activo</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Config -->
      <section id="configSec" class="cardx hidden">
        <h3>Configuración</h3>
        <div class="row">
          <div>
            <label>Nombre de la tienda</label>
            <input id="sName">
          </div>
          <div>
            <label>Número WhatsApp (sin +)</label>
            <input id="waNum" placeholder="549351...">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Precio de envío (ARS)</label>
            <input id="shipPrice" type="number" min="0" step="1" placeholder="Ej: 2500"/>
            <div class="muted" style="font-size:12px;margin-top:6px">Se aplica al carrito automáticamente (no editable desde el carrito).</div>
          </div>
          <div>
            <label>Texto previo WhatsApp (preHeader)</label>
            <input id="waPreHeader" placeholder="Ej: Nuevo pedido"/>
            <div class="muted" style="font-size:12px;margin-top:6px">Encabezado que se incluye en el mensaje del pedido por WhatsApp.</div>
          </div>
        </div>

        <div class="row3" style="margin-top:8px">
          <div><label>Color texto</label><input id="cText" type="color"></div>
          <div><label>Color tarjeta</label><input id="cCard" type="color"></div>
          <div><label>Color borde</label><input id="cBorder" type="color"></div>
        </div>
        <div class="row3" style="margin-top:8px">
          <div><label>Brand</label><input id="cBrand" type="color"></div>
          <div><label>Accent</label><input id="cAccent" type="color"></div>
          <div><label>BG</label><input id="cBg" type="color"></div>
        </div>
        <h4 style="margin-top:12px">SEO</h4>
        <div class="row">
          <div><label>Título</label><input id="seoTitle"></div>
          <div><label>Descripción</label><input id="seoDesc"></div>
        </div>
        <h4 style="margin-top:12px">Páginas</h4>
        <div class="row">
          <div><label>Quiénes somos</label><textarea id="pgAbout" rows="4"></textarea></div>
          <div><label>Contacto</label><textarea id="pgContact" rows="4"></textarea></div>
        </div>
        <div class="row">
          <div><label>Cambios/Devoluciones</label><textarea id="pgReturns" rows="4"></textarea></div>
          <div><label>Privacidad</label><textarea id="pgPrivacy" rows="4"></textarea></div>
        </div>

        <hr/>
        <h3>Guardar en GitHub</h3>
        <div class="row3">
          <div><label>API Base (ej: /api)</label><input id="apiBase" placeholder="/api"></div>
          <div>
            <label>Save Token</label>
            <div class="flex">
              <input id="saveToken" type="password" placeholder="(no se guarda en repo)" style="flex:1">
              <button class="btn secondary small" id="toggleTok" type="button">👁</button>
            </div>
          </div>
          <div>
            <label>Probar conexión</label>
            <button class="btn" id="testApi">Test</button>
            <div id="testInfo" class="muted" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="flex" style="margin-top:8px">
          <button class="btn success" id="saveAll">Guardar todo</button>
          <button class="btn secondary" id="dlAll">Descargar JSON</button>
          <label class="badge" style="margin-left:auto">
            <input type="checkbox" id="autoSaveToggle"> Autoguardar cada 60s
          </label>
        </div>

        <hr/>
        <h3>Seguridad</h3>
        <div class="row">
          <div>
            <label>Nueva contraseña</label>
            <input id="newPass" type="password" placeholder="Nueva contraseña">
          </div>
          <div>
            <label>Confirmar</label>
            <input id="newPass2" type="password" placeholder="Repetir contraseña">
          </div>
        </div>
        <div class="muted">Al cambiarla, te damos el hash para reemplazá HASHED por el nuevo valor.</div>
      </section>
    </section>
  </div>

  <!-- Botón flotante de guardado (visible en móvil) -->
  <button id="fabSave" class="btn brand fab-save">Guardar <span class="dot" id="fabDot" style="background:#9CA3AF"></span></button>

  <!-- Modal de Importación -->
  <dialog id="importDlg">
    <div class="dlg-head">Importar productos.json — Vista previa de cambios</div>
    <div class="dlg-body" id="importPreview"></div>
    <div class="dlg-foot">
      <button class="btn secondary" id="importCancel" type="button">Cancelar</button>
      <button class="btn brand" id="importApply" type="button">Aplicar</button>
    </div>
  </dialog>

  <script>
    /* =================== Setup base/RAW GH =================== */
    const GH_OWNER  = "ludmilasolutions";
    const GH_REPO   = "mgv";
    const GH_BRANCH = "main";
    function rawBase(sha){ return \`https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${sha||GH_BRANCH}/data\`; }

    function setLastSHA(sha){
      try{ if(!sha) return; localStorage.setItem('mgv_last_sha', sha);
        document.cookie='mgvsha='+sha+';path=/;max-age='+(60*60*24*30);
      }catch(_){}
    }
    function getLastSHA(){
      try{ const u=new URL(location.href); const qs=u.searchParams.get('sha'); if(qs){ setLastSHA(qs); return qs; } }catch(_){}
      try{ const ls=localStorage.getItem('mgv_last_sha'); if(ls) return ls; }catch(_){}
      try{ const m=document.cookie.match(/(?:^|;)\\s*mgvsha=([^;]+)/); if(m) return m[1]; }catch(_){}
      return null;
    }

    /* =================== Auth mínima (cliente) =================== */
    const SALT = "mgv~panel#2025";
    const HASHED = "b950ddfbf98b1a566a9445e569d2e31e894a8026cbf0eb447846b254c820ce23";
    async function sha256(str){const buf=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256',buf); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');}
    function show(id, yes){ document.getElementById(id).classList.toggle('hidden', !yes) }

    const sess = {
      get logged(){ return localStorage.getItem("mgv_logged")==="1" },
      login(){ localStorage.setItem("mgv_logged","1"); },
      logout(){ localStorage.removeItem("mgv_logged"); }
    };

    async function doLogin(){
      const u=document.getElementById("user").value.trim();
      const p=document.getElementById("pass").value;
      if(u!=="admin"){ alert("Usuario inválido"); return; }
      const h=await sha256(SALT+p);
      if(h!==HASHED){ alert("Contraseña incorrecta"); return; }
      sess.login(); boot();
    }

    /* =================== Estado/dirty/autosave =================== */
    let DIRTY=false;
    let AUTOSAVE=false;
    let autosaveTimer=null;
    const markDirty=()=>{ 
      DIRTY=true; 
      document.getElementById('dirtyDot').style.display='';
      const dot=document.getElementById('fabDot'); if(dot) dot.style.background='#f59e0b';
    };
    const clearDirty=()=>{ 
      DIRTY=false; 
      document.getElementById('dirtyDot').style.display='none';
      const dot=document.getElementById('fabDot'); if(dot) dot.style.background='#10b981';
    };
    window.addEventListener('beforeunload', e=>{ if(DIRTY){ e.preventDefault(); e.returnValue=''; }});
    document.addEventListener('keydown', e=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveAll(); }
    });
    function startAutosave(){
      if(autosaveTimer) clearInterval(autosaveTimer);
      if(!AUTOSAVE) return;
      autosaveTimer = setInterval(()=>{ if(DIRTY) saveAll(); }, 60000);
    }

    /* =================== Datos =================== */
    let productos=[], banners=[], config=null;

    async function fetchJsonWithRetry(url, tries=6, wait=700){
      for(let i=0;i<tries;i++){
        try{ const r=await fetch(url,{cache:"no-store"}); if(r.ok){ return await r.json(); } }
        catch(_){}
        await new Promise(res=>setTimeout(res,wait));
      }
      const r=await fetch(url,{cache:"no-store"});
      return r.json();
    }

    async function loadTables(sha){
      const BASE = rawBase(sha || window.__MGV_PENDING_SHA);
      const ts = Date.now();
      productos = await fetchJsonWithRetry(\`\${BASE}/productos.json?ts=\${ts}\`);
      banners   = await fetchJsonWithRetry(\`\${BASE}/banners.json?ts=\${ts}\`);
      config    = await fetchJsonWithRetry(\`\${BASE}/config.json?ts=\${ts}\`);
      window.__MGV_PENDING_SHA = null;
      computeCats();
      renderProductos();
      renderBanners();
      hydrateConfigUI();
      updateApiStatus();
      clearDirty();
    }

    /* =================== Upload imagen =================== */
    async function uploadImageFile(file){
      if(!file) return { ok:false, error:"No file" };
      if(file.size > 2*1024*1024) return { ok:false, error:"Archivo > 2MB" };
      const fd=new FormData();
      fd.append("file",file,file.name);
      const api=(localStorage.getItem("mgv_apiBase")||"/api")+"/upload-image";
      const tok=(localStorage.getItem("mgv_saveToken")||"").trim();
      const headers = tok ? { "Authorization":"Bearer "+tok } : {};
      const t0=performance.now();
      const resp=await fetch(api,{ method:"POST", headers, body:fd });
      const ms=Math.round(performance.now()-t0);
      let out; try{ out=await resp.json(); }catch(_){ out={ok:false,error:"Respuesta inválida de la API"}; }
      if(out && ms) out.latency=ms;
      return out;
    }

    /* =================== Helpers =================== */
    const toInt = v => { const n = parseInt(String(v??"").replace(/[^\d-]/g,""), 10); return isNaN(n) ? 0 : Math.max(0, n); };
    const money = n => { try{ n=Number(n||0);}catch(_){n=0} return n.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}); };
    const round100 = n => Math.round(Number(n||0)/100)*100;

    /* =================== Tabs/Login =================== */
    function boot(){
      if(!localStorage.getItem("mgv_apiBase")) localStorage.setItem("mgv_apiBase","/api");
      show("loginSec", !sess.logged);
      show("appSec",  sess.logged);
      if(sess.logged){
        const _sha=getLastSHA();
        loadTables(_sha);
        updateApiStatus();
        AUTOSAVE = localStorage.getItem('mgv_autosave')==='1';
        document.getElementById('autoSaveToggle').checked = AUTOSAVE;
        startAutosave();
      }
      const fab=document.getElementById('fabSave'); if(fab){ fab.onclick=saveAll; }
      document.getElementById("loginBtn").onclick=doLogin;
      document.getElementById("logoutBtn").onclick=()=>{ sess.logout(); boot(); };
    }

    const tabs={productosSec:"tabProductos",bannersSec:"tabBanners",configSec:"tabConfig"};
    Object.entries(tabs).forEach(([sec,btn])=>{
      document.getElementById(btn).onclick=()=>{ Object.keys(tabs).forEach(id=>show(id,id===sec)); };
    });

    /* =================== Productos: estado de UI =================== */
    const ui = {
      q:'', cat:'', noImg:false, noDesc:false, noPrice:false,
      page:1, pageSize:50,
      selected:new Set(),
      dragging:null,
    };

    function computeCats(){
      const sel=document.getElementById('prodCatFilter');
      const cats=[...new Set((productos||[]).map(p=>p.categoria).filter(Boolean))].sort();
      sel.innerHTML='<option value="">Categoría: todas</option>'+cats.map(c=>`<option>${c}</option>`).join('');
    }

    function applyFilters(){
      let arr=[...productos];
      if(ui.q){
        const q=ui.q.toLowerCase();
        arr=arr.filter(p=>(p.nombre||'').toLowerCase().includes(q)||(p.descripcion||'').toLowerCase().includes(q));
      }
      if(ui.cat) arr=arr.filter(p=>p.categoria===ui.cat);
      if(ui.noImg)  arr=arr.filter(p=>!p.imagen);
      if(ui.noDesc) arr=arr.filter(p=>!p.descripcion);
      if(ui.noPrice)arr=arr.filter(p=>!p.precio || Number(p.precio)<=0);
      return arr;
    }

    function paginated(arr){
      const ps = ui.pageSize;
      const totalPages = Math.max(1, Math.ceil(arr.length/ps));
      ui.page = Math.min(ui.page, totalPages);
      const start = (ui.page-1)*ps;
      return { slice: arr.slice(start, start+ps), total: arr.length, totalPages };
    }

    function updateBulkButtons(){
      const hasSel = ui.selected.size>0;
      document.getElementById('bulkDelete').disabled = !hasSel;
      document.getElementById('bulkUp10').disabled  = !hasSel;
      document.getElementById('bulkRound').disabled = !hasSel;
    }

    function renderProductos(){
      const tbody=document.querySelector("#tablaProductos tbody");
      tbody.innerHTML="";

      const filtered = applyFilters();
      const {slice, total, totalPages} = paginated(filtered);
      document.getElementById('rowsInfo').textContent = `${total} ítems (mostrando ${slice.length})`;
      document.getElementById('pageLabel').textContent = `${ui.page} / ${totalPages}`;

      const hdrChk=document.getElementById('hdrChk');
      hdrChk.checked = slice.length && slice.every(p=>ui.selected.has(String(p.id)));
      hdrChk.onchange = ()=>{ slice.forEach(p=>{ const id=String(p.id); if(hdrChk.checked) ui.selected.add(id); else ui.selected.delete(id); }); renderProductos(); };

      slice.forEach(p=>{
        const tr=document.createElement("tr");
        tr.draggable=true;
        tr.dataset.id = String(p.id);
        tr.classList.toggle('dragging', ui.dragging===String(p.id));
        tr.innerHTML=`
          <td class="drag-handle col-aux" title="Arrastrar">☰</td>
          <td class="col-aux"><input type="checkbox" class="rowChk" data-id="${p.id}" ${ui.selected.has(String(p.id))?'checked':''}></td>
          <td data-label="Nombre"><input value="${p.nombre ?? ''}" data-f="nombre" data-id="${p.id}"/></td>
          <td data-label="Precio">
            <input value="${toInt(p.precio)}" type="number" step="1" min="0" inputmode="numeric" pattern="[0-9]*"
                   data-f="precio" data-id="${p.id}" />
          </td>
          <td data-label="Categoría"><input value="${p.categoria ?? ''}" data-f="categoria" data-id="${p.id}"/></td>
          <td data-label="Imagen">
            <div class="td-img">
              <input class="url" value="${p.imagen ?? ''}" placeholder="https://…/img.jpg" data-f="imagen" data-id="${p.id}"/>
              <label class="img-upload">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 16v-8m0 0l-3 3m3-3l3 3M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Subir…</span>
                <input type="file" accept="image/*" data-file="${p.id}"/>
              </label>
              <img class="preview-thumb" src="${(window.bustURL||((x)=>x))(p.imagen || '')}" alt="Vista previa"/>
              <span class="muted" data-status="${p.id}"></span>
            </div>
          </td>
          <td class="td-actions" data-label="Acciones">
            <button class="btn secondary small" data-ed="${p.id}">Desc</button>
            <button class="btn secondary small mv-btn" data-up="${p.id}">↑</button>
            <button class="btn secondary small mv-btn" data-dn="${p.id}">↓</button>
            <button class="btn danger small" data-del="${p.id}">Borrar</button>
          </td>`;
        tbody.appendChild(tr);
      });

      /* Drag & drop desktop */
      tbody.querySelectorAll("tr").forEach(tr=>{
        tr.addEventListener('dragstart', (e)=>{
          ui.dragging = tr.dataset.id; tr.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
        });
        tr.addEventListener('dragover', e=>{ e.preventDefault(); });
        tr.addEventListener('drop', e=>{
          e.preventDefault();
          const fromId = ui.dragging;
          const toId   = tr.dataset.id;
          ui.dragging=null;
          const fromIdxGlobal = productos.findIndex(x=>String(x.id)===String(fromId));
          const toIdxGlobal   = productos.findIndex(x=>String(x.id)===String(toId));
          if(fromIdxGlobal<0 || toIdxGlobal<0) return;
          const [moved] = productos.splice(fromIdxGlobal,1);
          productos.splice(toIdxGlobal,0,moved);
          markDirty(); renderProductos();
        });
        tr.addEventListener('dragend', ()=>{ ui.dragging=null; tr.classList.remove('dragging'); });
      });

      /* Selección */
      tbody.querySelectorAll('.rowChk').forEach(chk=>{
        chk.onchange = ()=>{ const id=String(chk.dataset.id); if(chk.checked) ui.selected.add(id); else ui.selected.delete(id); updateBulkButtons(); };
      });

      /* Evitar zoom por scroll en inputs numéricos */
      tbody.querySelectorAll("input[type='number'][data-f='precio']").forEach(n=>{
        n.addEventListener('wheel', e=> e.preventDefault(), {passive:false});
      });

      /* Inputs: sync + preview con bust */
      tbody.querySelectorAll("input.url, td input[type='text'], td input[type='number']").forEach(inp=>{
        const handler=()=>{
          const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
          const p=productos.find(x=>String(x.id)===String(id)); if(!p) return;
          if(f==="precio"){ p[f] = toInt(inp.value); inp.value = p[f]; }
          else{
            p[f]=inp.value;
            if(f==="imagen"){
              const row=inp.closest("tr");
              const img=row?.querySelector("img.preview-thumb");
              if(img) img.src = (window.bustURL||((x)=>x))(inp.value.trim());
            }
          }
          markDirty();
        };
        inp.addEventListener("input",handler);
        inp.addEventListener("change",handler);
      });

      /* Upload imagen Productos */
      tbody.querySelectorAll("input[type=file][data-file]").forEach(fi=>{
        fi.addEventListener("change", async ()=>{
          const id=fi.dataset.file;
          const row=fi.closest("tr");
          const urlInp=row.querySelector("input.url[data-id='"+id+"']");
          const prev=row.querySelector("img.preview-thumb");
          const st=row.querySelector("[data-status='"+id+"']");
          const file=fi.files?.[0];
          fi.value="";
          if(!file) return;
          st.textContent="Subiendo imagen…";
          try{
            const res=await uploadImageFile(file);
            if(res.ok){
              urlInp.value=res.url;
              if(prev) prev.src=(window.bustURL||((x)=>x))(res.url);
              const p=productos.find(x=>String(x.id)===String(id)); if(p) p.imagen=res.url;
              st.innerHTML = \`Listo ✔ <span class="muted">(\${res.latency||'?'} ms)</span>\`;
              if(res.commitSha){ setLastSHA(res.commitSha); window.__MGV_PENDING_SHA=res.commitSha; }
              markDirty();
            }else{
              st.innerHTML=\`<span class="status-err">Error: \${(res.error||"no se pudo subir")}</span>\`;
            }
          }catch(e){
            st.innerHTML=\`<span class="status-err">Error: \${e.message}</span>\`;
          }
        });
      });

      /* Editar / borrar */
      tbody.querySelectorAll("[data-ed]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.ed; const p=productos.find(x=>String(x.id)===String(id)); const d=prompt("Descripción",p.descripcion||""); if(d!==null){ p.descripcion=d; markDirty(); renderProductos(); } };
      });
      tbody.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick=()=>{ const id=b.dataset.del; if(confirm("¿Eliminar producto?")){ productos=productos.filter(x=>String(x.id)!==String(id)); ui.selected.delete(String(id)); markDirty(); renderProductos(); } };
      });

      /* Reordenar en móvil (↑ ↓) */
      tbody.querySelectorAll("[data-up]").forEach(btn=>{
        btn.onclick=()=>{
          const id=String(btn.dataset.up);
          const idx=productos.findIndex(x=>String(x.id)===id);
          if(idx>0){ const [it]=productos.splice(idx,1); productos.splice(idx-1,0,it); markDirty(); renderProductos(); }
        };
      });
      tbody.querySelectorAll("[data-dn]").forEach(btn=>{
        btn.onclick=()=>{
          const id=String(btn.dataset.dn);
          const idx=productos.findIndex(x=>String(x.id)===id);
          if(idx>=0 && idx<productos.length-1){ const [it]=productos.splice(idx,1); productos.splice(idx+1,0,it); markDirty(); renderProductos(); }
        };
      });

      updateBulkButtons();
    }

    /* Filtros / paginación */
    document.getElementById('prodSearch').oninput = (e)=>{ ui.q=e.target.value; ui.page=1; renderProductos(); };
    document.getElementById('prodCatFilter').onchange = (e)=>{ ui.cat=e.target.value; ui.page=1; renderProductos(); };
    document.getElementById('fNoImg').onchange  = (e)=>{ ui.noImg=e.target.checked; ui.page=1; renderProductos(); };
    document.getElementById('fNoDesc').onchange = (e)=>{ ui.noDesc=e.target.checked; ui.page=1; renderProductos(); };
    document.getElementById('fNoPrice').onchange= (e)=>{ ui.noPrice=e.target.checked; ui.page=1; renderProductos(); };
    document.getElementById('clearFilters').onclick = ()=>{ ui.q=''; ui.cat=''; ui.noImg=ui.noDesc=ui.noPrice=false; ui.page=1; document.getElementById('prodSearch').value=''; document.getElementById('prodCatFilter').value=''; ['fNoImg','fNoDesc','fNoPrice'].forEach(id=>document.getElementById(id).checked=false); renderProductos(); };

    document.getElementById('pageSize').onchange = (e)=>{ ui.pageSize=parseInt(e.target.value,10)||50; ui.page=1; renderProductos(); };
    document.getElementById('pagePrev').onclick = ()=>{ if(ui.page>1){ ui.page--; renderProductos(); } };
    document.getElementById('pageNext').onclick = ()=>{ ui.page++; renderProductos(); };

    document.getElementById('selectAll').onchange = (e)=>{
      const filtered = applyFilters(); const {slice} = paginated(filtered);
      slice.forEach(p=>{ const id=String(p.id); if(e.target.checked) ui.selected.add(id); else ui.selected.delete(id); });
      renderProductos();
    };

    /* Acciones masivas */
    document.getElementById('bulkDelete').onclick = ()=>{
      if(!ui.selected.size) return;
      if(!confirm('¿Borrar los productos seleccionados?')) return;
      productos = productos.filter(p=>!ui.selected.has(String(p.id)));
      ui.selected.clear(); markDirty(); renderProductos();
    };
    document.getElementById('bulkUp10').onclick = ()=>{
      if(!ui.selected.size) return;
      productos.forEach(p=>{ if(ui.selected.has(String(p.id))){ p.precio = Math.round(Number(p.precio||0)*1.10); }});
      markDirty(); renderProductos();
    };
    document.getElementById('bulkRound').onclick = ()=>{
      if(!ui.selected.size) return;
      productos.forEach(p=>{ if(ui.selected.has(String(p.id))){ p.precio = round100(p.precio); }});
      markDirty(); renderProductos();
    };

    /* =================== Banners =================== */
    function renderBanners(){
      const tbody=document.querySelector("#tablaBanners tbody");
      tbody.innerHTML="";
      banners.forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td data-label="Título"><input value="${b.titulo ?? ''}" data-f="titulo" data-id="${b.id}"/></td>
          <td data-label="Texto"><input value="${b.texto ?? ''}" data-f="texto" data-id="${b.id}"/></td>
          <td data-label="Color"><input value="${b.color ?? '#111111'}" data-f="color" data-id="${b.id}"/></td>
          <td data-label="Imagen">
            <div class="td-img">
              <input class="url" value="${b.imagen ?? ''}" placeholder="https://…/banner.jpg" data-f="imagen" data-id="${b.id}"/>
              <label class="img-upload">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 16v-8m0 0l-3 3m3-3l3 3M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Subir…</span>
                <input type="file" accept="image/*" data-bfile="${b.id}"/>
              </label>
              <img class="preview-thumb" src="${(window.bustURL||((x)=>x))(b.imagen || '')}" alt="Vista banner"/>
              <span class="muted" data-bstatus="${b.id}"></span>
            </div>
          </td>
          <td data-label="Activo"><input type="checkbox" ${b.activo!==false?'checked':''} data-f="activo" data-id="${b.id}"/></td>
          <td class="flex td-actions" data-label="Acciones"><button class="btn danger small" data-del="${b.id}">Borrar</button></td>`;
        tbody.appendChild(tr);
      });

      /* Inputs de banners (incluye imagen URL con preview + bust) */
      tbody.querySelectorAll("input").forEach(inp=>{
        const handler=()=>{
          const id=inp.dataset.id, f=inp.dataset.f; const bn=banners.find(x=>x.id===id); if(!bn) return;
          bn[f]=(f==="activo")? inp.checked:inp.value;
          if(f==="imagen"){
            const row=inp.closest("tr");
            const img=row?.querySelector("img.preview-thumb");
            if(img) img.src=(window.bustURL||((x)=>x))(String(inp.value||'').trim());
          }
          markDirty();
        };
        inp.addEventListener("input",handler); inp.addEventListener("change",handler);
      });

      /* Subida de imagen para banners */
      tbody.querySelectorAll("input[type=file][data-bfile]").forEach(fi=>{
        fi.addEventListener("change", async ()=>{
          const id=fi.dataset.bfile;
          const row=fi.closest("tr");
          const urlInp=row.querySelector("input.url[data-id='"+id+"']");
          const prev=row.querySelector("img.preview-thumb");
          const st=row.querySelector("[data-bstatus='"+id+"']");
          const file=fi.files?.[0];
          fi.value="";
          if(!file) return;
          st.textContent="Subiendo imagen…";
          try{
            const res=await uploadImageFile(file);
            if(res.ok){
              urlInp.value=res.url;
              if(prev) prev.src=(window.bustURL||((x)=>x))(res.url);
              const bn=banners.find(x=>x.id===id); if(bn) bn.imagen=res.url;
              st.innerHTML = \`Listo ✔ <span class="muted">(\${res.latency||'?'} ms)</span>\`;
              if(res.commitSha){ setLastSHA(res.commitSha); window.__MGV_PENDING_SHA=res.commitSha; }
              markDirty();
            }else{
              st.innerHTML=\`<span class="status-err">Error: \${(res.error||"no se pudo subir")}</span>\`;
            }
          }catch(e){
            st.innerHTML=\`<span class="status-err">Error: \${e.message}</span>\`;
          }
        });
      });

      /* Borrar / Nuevo */
      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick=()=>{ const id=btn.dataset.del; if(confirm("¿Eliminar banner?")){ banners=banners.filter(x=>x.id!==id); markDirty(); renderBanners(); } };
      });
      document.getElementById("nuevoBanner").onclick=()=>{
        const id="b"+Math.random().toString(36).slice(2,7);
        banners.unshift({id, titulo:"Nuevo banner", texto:"", imagen:"", color:"#111111", activo:true});
        markDirty(); renderBanners();
      };
    }

    /* =================== Config =================== */
    function hydrateConfigUI(){
      if(!config) return;
      document.getElementById("sName").value = config.storeName||"";
      document.getElementById("waNum").value = (config.whatsapp&&config.whatsapp.number)||"";
      document.getElementById("waPreHeader").value = (config.whatsapp&&config.whatsapp.preHeader)||"";
      document.getElementById("shipPrice").value = (config.shipping && (config.shipping.price ?? config.shipping.default)) || 0;

      const t=config.theme||{}
      document.getElementById("cText").value=t.text||"#111111";
      document.getElementById("cCard").value=t.card||"#f7f7f8";
      document.getElementById("cBorder").value=t.border||"#e5e7eb";
      document.getElementById("cBrand").value=t.brand||"#111111";
      document.getElementById("cAccent").value=t.accent||"#d4af37";
      document.getElementById("cBg").value=t.bg||"#ffffff";

      document.getElementById("seoTitle").value=(config.seo&&config.seo.title)||"";
      document.getElementById("seoDesc").value =(config.seo&&config.seo.description)||"";
      document.getElementById("pgAbout").value =(config.pages&&config.pages.about)||"";
      document.getElementById("pgContact").value=(config.pages&&config.pages.contact)||"";
      document.getElementById("pgReturns").value=(config.pages&&config.pages.returns)||"";
      document.getElementById("pgPrivacy").value=(config.pages&&config.pages.privacy)||"";

      document.getElementById("apiBase").value   = localStorage.getItem("mgv_apiBase") || "/api";
      document.getElementById("saveToken").value = localStorage.getItem("mgv_saveToken") || "";
      document.getElementById("toggleTok").onclick = ()=>{
        const inp=document.getElementById('saveToken'); inp.type = (inp.type==='password'?'text':'password');
      };
      document.getElementById("testApi").onclick = testApi;
      document.getElementById("saveAll").onclick = saveAll;
      document.getElementById("dlAll").onclick   = dlAll;
      document.getElementById("saveNow").onclick = saveAll;
      document.getElementById("saveNow2").onclick= saveAll;

      document.querySelectorAll("#configSec input, #configSec textarea, #configSec select").forEach(el=>{
        el.addEventListener('input', markDirty);
        el.addEventListener('change', markDirty);
      });

      const auto = localStorage.getItem('mgv_autosave')==='1';
      document.getElementById('autoSaveToggle').checked = auto;
      AUTOSAVE = auto; startAutosave();
      document.getElementById('autoSaveToggle').onchange = (e)=>{
        AUTOSAVE = e.target.checked; localStorage.setItem('mgv_autosave', AUTOSAVE?'1':'0'); startAutosave();
      };
    }

    function gatherConfigFromUI(){
      const t=(config.theme=config.theme||{});
      config.storeName=document.getElementById("sName").value;
      config.whatsapp=config.whatsapp||{};
      config.whatsapp.number=document.getElementById("waNum").value;
      config.whatsapp.preHeader=document.getElementById("waPreHeader").value;
      config.shipping = config.shipping || {};
      config.shipping.price = toInt(document.getElementById("shipPrice").value);
      t.text  =document.getElementById("cText").value;
      t.card  =document.getElementById("cCard").value;
      t.border=document.getElementById("cBorder").value;
      t.brand =document.getElementById("cBrand").value;
      t.accent=document.getElementById("cAccent").value;
      t.bg    =document.getElementById("cBg").value;
      config.seo=config.seo||{};
      config.seo.title=document.getElementById("seoTitle").value;
      config.seo.description=document.getElementById("seoDesc").value;
      config.pages=config.pages||{};
      config.pages.about  =document.getElementById("pgAbout").value;
      config.pages.contact=document.getElementById("pgContact").value;
      config.pages.returns=document.getElementById("pgReturns").value;
      config.pages.privacy=document.getElementById("pgPrivacy").value;
    }

    function updateApiStatus(){
      const base=localStorage.getItem("mgv_apiBase");
      const tok =localStorage.getItem("mgv_saveToken");
      document.getElementById("apiStatus").textContent=\`API: \${base||'sin URL'} · Token \${tok?'listo':'falta'}\`;
    }

    async function testApi(){
      const base=(document.getElementById("apiBase").value.trim()||"/api");
      const tok =document.getElementById("saveToken").value.trim();
      localStorage.setItem("mgv_apiBase", base);
      localStorage.setItem("mgv_saveToken", tok);
      updateApiStatus();
      const out=document.getElementById('testInfo');
      try{
        const t0=performance.now();
        const r=await fetch(base+"/ping",{headers: tok?{"Authorization":"Bearer "+tok}:{}} );
        const ms=Math.round(performance.now()-t0);
        let j={}; try{ j=await r.json(); }catch(_){}
        out.innerHTML = r.ok
          ? \`Latencia: <b>\${ms} ms</b> · Versión: <b>\${j.version||j.ver||'n/d'}</b>\`
          : \`Fallo (\${r.status}) en \${ms} ms\`;
      }catch(e){ out.textContent="No se pudo conectar: "+e.message; }
    }

    function syncTablesBeforeSave(){
      document.querySelectorAll("#tablaProductos tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const p=productos.find(x=>String(x.id)===String(id)); if(!p) return;
        p[f]=(f==="precio")? toInt(inp.value):inp.value;
      });
      document.querySelectorAll("#tablaBanners tbody input").forEach(inp=>{
        const id=inp.dataset.id, f=inp.dataset.f; if(!id||!f) return;
        const b=banners.find(x=>x.id===id); if(!b) return;
        b[f]=(f==="activo")? inp.checked:inp.value;
      });
    }

    function dlAll(){
      const a=(name,txt)=>{const blob=new Blob([txt],{type:"application/json"}); const el=document.createElement("a"); el.href=URL.createObjectURL(blob); el.download=name; el.click(); URL.revokeObjectURL(el.href);};
      gatherConfigFromUI();
      a("productos.json", JSON.stringify(productos,null,2));
      a("banners.json",   JSON.stringify(banners,null,2));
      a("config.json",    JSON.stringify(config,null,2));
    }

    async function saveAll(){
      syncTablesBeforeSave(); gatherConfigFromUI();
      const base=localStorage.getItem("mgv_apiBase")||"/api";
      const tok =localStorage.getItem("mgv_saveToken")||"";
      try{
        const r=await fetch(base+"/save_catalog",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+tok},body:JSON.stringify({productos,banners,config})});
        const txt=await r.text(); let j={}; try{ j=JSON.parse(txt);}catch(_){}
        if(r.ok){
          if (j && Array.isArray(j.commits) && j.commits.length) { window.__MGV_PENDING_SHA=j.commits[j.commits.length-1]; setLastSHA(window.__MGV_PENDING_SHA); }
          toast("Guardado en GitHub ✔️"); await loadTables(window.__MGV_PENDING_SHA); clearDirty();
        } else { alert("Error "+r.status+": "+(j.error||txt)); }
      }catch(e){ alert("Error de red: "+e.message); }
    }

    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 2500);
    }

    document.getElementById("newPass2").onchange=async ()=>{
      const p1=document.getElementById("newPass").value;
      const p2=document.getElementById("newPass2").value;
      if(!p1 || p1!==p2){ alert("Las contraseñas no coinciden"); return; }
      const h=await sha256(SALT+p1);
      alert("Hash generado. Para cambiarla, abrí este archivo y reemplazá HASHED por:\n\n"+h+"\n\nLuego subilo al repo.");
    };

    document.getElementById('dlAll').onclick = dlAll;

    boot();
  </script>
</body>
</html>
